<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Command Center</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0f1117;
      --surface: #1a1d2e;
      --card: #222639;
      --border: #2d3154;
      --shell-bg: #1d2236;
      --chip-bg: #2d3154;
      --chip-border: #3b4270;
      --soft-accent-bg: rgba(99,102,241,0.1);
      --text: #e2e8f0;
      --text-secondary: #8892b0;
      --accent: #6366f1;
      --success: #22c55e;
      --warn: #f59e0b;
      --danger: #ef4444;
      --shadow: 0 10px 20px rgba(0,0,0,0.25);
      --radius: 14px;
      --radius-lg: 18px;
    }

    [data-theme="light"] {
      --bg: #edf2f8;
      --surface: #ffffff;
      --card: #fdfefe;
      --border: #cbd5e1;
      --shell-bg: #f8fbff;
      --chip-bg: #e2e8f0;
      --chip-border: #cbd5e1;
      --soft-accent-bg: rgba(79,70,229,0.12);
      --text: #1e293b;
      --text-secondary: #475569;
      --accent: #4f46e5;
      --shadow: 0 10px 22px rgba(15, 23, 42, 0.14);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      background: radial-gradient(1200px 600px at 10% -10%, rgba(99,102,241,0.2), transparent 55%),
                  radial-gradient(900px 500px at 90% 0%, rgba(34,197,94,0.12), transparent 60%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
      transition: background 0.2s ease, color 0.2s ease;
    }

    body[data-theme="light"] {
      background: radial-gradient(1200px 600px at 10% -10%, rgba(79,70,229,0.16), transparent 55%),
                  radial-gradient(900px 500px at 90% 0%, rgba(34,197,94,0.12), transparent 60%),
                  var(--bg);
    }

    .app {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 5;
      background: linear-gradient(180deg, rgba(15,17,23,0.95), rgba(15,17,23,0.7));
      backdrop-filter: blur(14px);
      border-bottom: 1px solid var(--border);
      padding: 14px 16px 10px;
    }

    [data-theme="light"] header {
      background: linear-gradient(180deg, rgba(245,247,250,0.95), rgba(245,247,250,0.8));
    }

    .top-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.2px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .icon-btn {
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    }

    .icon-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .stats {
      display: grid;
      gap: 8px;
    }

    .stats-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .stats-row strong { color: var(--text); }

    .progress {
      width: 100%;
      height: 6px;
      background: var(--border);
      border-radius: 999px;
      overflow: hidden;
    }

    .progress > span {
      display: block;
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #22c55e);
      border-radius: 999px;
      transition: width 0.3s ease;
    }

    main {
      flex: 1;
      padding: 12px 14px 90px;
    }

    .columns {
      display: flex;
      transition: transform 0.35s ease;
      will-change: transform;
    }

    .column {
      min-width: 100%;
      padding: 10px 6px 16px;
    }

    .column-shell {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 220px;
      transition: background 0.2s ease, border-color 0.2s ease;
    }

    [data-theme="light"] .column-shell {
      background: var(--shell-bg);
    }

    .column-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      font-weight: 600;
    }

    .column-title {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .badge {
      background: var(--chip-bg);
      border: 1px solid var(--chip-border);
      color: var(--text);
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-left: 4px solid var(--accent);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      animation: fadeInUp 0.35s ease both;
      color: var(--text);
      opacity: 1;
    }

    [data-theme="light"] .card {
      box-shadow: 0 8px 16px rgba(15,23,42,0.08);
      border-color: #94a3b8;
    }
    [data-theme="light"] .card h4 {
      color: #0f172a;
      font-weight: 700;
    }
    [data-theme="light"] .meta .chip {
      background: #e2e8f0;
      color: #334155;
      border-color: #94a3b8;
    }

    @media (hover: hover) and (pointer: fine) {
      .card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow);
      }
    }

    .card h4 {
      margin: 0 0 6px;
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
    }

    .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 10px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .pill {
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--chip-bg);
      border: 1px solid var(--chip-border);
      color: var(--text);
      font-size: 11px;
      font-weight: 500;
    }

    .add-btn {
      margin-top: auto;
      border: 1px dashed var(--border);
      background: transparent;
      color: var(--text-secondary);
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: border-color 0.2s ease, color 0.2s ease, background 0.2s ease;
    }

    .add-btn:hover { border-color: var(--accent); color: var(--text); background: var(--soft-accent-bg); }

    .tabbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      padding: 8px 10px 12px;
      z-index: 6;
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 8px 4px;
      border-radius: 10px;
      font-size: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: color 0.2s ease, background 0.2s ease;
    }

    .tab.active {
      background: var(--soft-accent-bg);
      color: var(--text);
      font-weight: 600;
    }

    .done-collapsed {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      cursor: pointer;
      background: var(--soft-accent-bg);
      color: var(--text-secondary);
    }

    .activity-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 320px;
      max-width: 90vw;
      height: 100vh;
      background: var(--surface);
      border-left: 1px solid var(--border);
      transform: translateX(100%);
      transition: transform 0.35s ease;
      z-index: 7;
      padding: 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .activity-panel.open { transform: translateX(0); }

    .activity-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-y: auto;
      padding-right: 6px;
    }

    .activity-item {
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 12px;
      padding: 10px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .activity-item strong { color: var(--text); display: block; margin-bottom: 4px; }
    .activity-item span { color: var(--text-secondary); }

    .menu {
      position: relative;
    }

    .menu-panel {
      position: absolute;
      right: 0;
      top: 42px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 6px;
      min-width: 150px;
      box-shadow: var(--shadow);
      display: none;
      z-index: 8;
    }

    .menu-panel.open { display: block; }

    .menu-panel button {
      width: 100%;
      border: none;
      background: transparent;
      color: var(--text);
      padding: 8px 10px;
      text-align: left;
      border-radius: 8px;
      cursor: pointer;
    }

    .menu-panel button:hover { background: rgba(99,102,241,0.12); }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9;
    }

    .modal-backdrop.open { display: flex; }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      width: min(520px, 94vw);
      max-height: 92vh;
      overflow-y: auto;
      padding: 16px;
      animation: modalIn 0.25s ease;
    }

    .modal.fullscreen {
      width: 100vw;
      height: 100vh;
      border-radius: 0;
      max-height: 100vh;
    }

    .modal h3 { margin: 0 0 10px; }

    .form-grid {
      display: grid;
      gap: 12px;
    }

    label { font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px; }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
    }

    textarea { min-height: 80px; resize: vertical; }

    .radio-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .radio-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .radio-pill input { width: auto; }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      display: inline-block;
    }

    .modal-actions {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 8px;
    }

    .btn {
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn.primary { background: var(--accent); color: white; }
    .btn.secondary { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .btn.danger { background: #ef4444; color: white; }

    .close-btn {
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 20px;
      cursor: pointer;
    }

    @keyframes fadeInUp {
      from { opacity: 0.5; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes modalIn {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (min-width: 720px) {
      main { padding: 16px 18px 24px; }
      .columns { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 14px; transform: none !important; }
      .column { min-width: 0; }
      .tabbar { display: none; }
    }

    @media (min-width: 1024px) {
      .columns { grid-template-columns: repeat(3, minmax(0,1fr)); gap: 16px; }
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    .card:focus-visible,
    .add-btn:focus-visible,
    .icon-btn:focus-visible,
    .btn:focus-visible,
    .tab:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="top-row">
        <div class="title">üöÄ Command Center</div>
        <div class="header-actions">
          <button class="icon-btn" id="themeToggle" title="Toggle theme">üåì</button>
          <button class="icon-btn" id="activityToggle" title="Activity log">üóÇÔ∏è</button>
          <div class="menu">
            <button class="icon-btn" id="menuToggle" title="Menu">‚ãÆ</button>
            <div class="menu-panel" id="menuPanel">
              <button id="exportBtn">Export JSON</button>
              <button id="importBtn">Import JSON</button>
            </div>
          </div>
        </div>
      </div>
      <div class="stats">
        <div class="stats-row">
          <span>Total <strong id="totalCount">0</strong></span>
          <span><strong id="completionPct">0%</strong> complete</span>
          <span>‚úÖ <strong id="doneCount">0</strong> üîÑ <strong id="activeCount">0</strong> üìã <strong id="plannedCount">0</strong></span>
        </div>
        <div class="progress"><span id="progressBar" style="width:0%"></span></div>
      </div>
    </header>

    <main>
      <div class="columns" id="columns"></div>
    </main>

    <div class="tabbar" id="tabbar">
      <div class="tab" data-tab="done">‚úÖ Done</div>
      <div class="tab" data-tab="active">üîÑ Active</div>
      <div class="tab" data-tab="planned">üìã Planned</div>
    </div>

    <div class="activity-panel" id="activityPanel">
      <div class="top-row">
        <strong>Activity Log</strong>
        <button class="icon-btn" id="activityClose">‚úï</button>
      </div>
      <div class="activity-list" id="activityList"></div>
    </div>

    <div class="modal-backdrop" id="modalBackdrop">
      <div class="modal" id="modal">
        <div class="top-row">
          <h3 id="modalTitle">Edit Task</h3>
          <button class="close-btn" id="modalClose">‚úï</button>
        </div>
        <div class="form-grid">
          <div>
            <label for="taskTitle">Title *</label>
            <input id="taskTitle" type="text" placeholder="Task title" required />
          </div>
          <div>
            <label for="taskProject">Project</label>
            <select id="taskProject">
              <option>CoachFinder</option>
              <option>Lead Intel</option>
              <option>Infrastructure</option>
              <option>Watson</option>
              <option>Other</option>
            </select>
          </div>
          <div>
            <label>Priority</label>
            <div class="radio-row">
              <label class="radio-pill"><input type="radio" name="priority" value="high" /> <span class="dot" style="background:#ef4444"></span> High</label>
              <label class="radio-pill"><input type="radio" name="priority" value="medium" /> <span class="dot" style="background:#f59e0b"></span> Medium</label>
              <label class="radio-pill"><input type="radio" name="priority" value="low" /> <span class="dot" style="background:#22c55e"></span> Low</label>
            </div>
          </div>
          <div>
            <label for="taskDue">Due Date</label>
            <input id="taskDue" type="date" />
          </div>
          <div>
            <label for="taskColumn">Column</label>
            <select id="taskColumn">
              <option value="done">Done</option>
              <option value="active">Active</option>
              <option value="planned">Planned</option>
            </select>
          </div>
          <div>
            <label for="taskNotes">Notes</label>
            <textarea id="taskNotes" placeholder="Add context, links, notes"></textarea>
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn danger" id="deleteBtn">Delete</button>
          <div style="display:flex; gap:8px; margin-left:auto;">
            <button class="btn secondary" id="cancelBtn">Cancel</button>
            <button class="btn primary" id="saveBtn">Save</button>
          </div>
        </div>
      </div>
    </div>

    <input type="file" id="importFile" accept="application/json" style="display:none" />
  </div>

  <script>
    const STORAGE_KEY = "ccv2_tasks";
    const LOG_KEY = "ccv2_activity";
    const THEME_KEY = "ccv2_theme";

    const columnsEl = document.getElementById("columns");
    const totalCountEl = document.getElementById("totalCount");
    const completionPctEl = document.getElementById("completionPct");
    const doneCountEl = document.getElementById("doneCount");
    const activeCountEl = document.getElementById("activeCount");
    const plannedCountEl = document.getElementById("plannedCount");
    const progressBarEl = document.getElementById("progressBar");
    const tabbarEl = document.getElementById("tabbar");
    const activityPanel = document.getElementById("activityPanel");
    const activityList = document.getElementById("activityList");
    const menuPanel = document.getElementById("menuPanel");
    const importFile = document.getElementById("importFile");

    const modalBackdrop = document.getElementById("modalBackdrop");
    const modal = document.getElementById("modal");
    const modalTitle = document.getElementById("modalTitle");
    const taskTitle = document.getElementById("taskTitle");
    const taskProject = document.getElementById("taskProject");
    const taskDue = document.getElementById("taskDue");
    const taskNotes = document.getElementById("taskNotes");
    const taskColumn = document.getElementById("taskColumn");
    const saveBtn = document.getElementById("saveBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const cancelBtn = document.getElementById("cancelBtn");

    const columns = [
      { key: "done", title: "Done", icon: "‚úÖ" },
      { key: "active", title: "Active", icon: "üîÑ" },
      { key: "planned", title: "Planned", icon: "üìã" }
    ];

    let tasks = [];
    let activity = [];
    let activeTab = "active";
    let doneCollapsed = false;
    let editingId = null;

    function nowISO() {
      return new Date().toISOString();
    }

    function safeParse(raw, fallback) {
      if (!raw) return fallback;
      try {
        return JSON.parse(raw);
      } catch {
        return fallback;
      }
    }

    function normalizeTask(input) {
      if (!input || typeof input !== "object") return null;
      const id = typeof input.id === "string" && input.id.trim() ? input.id : crypto.randomUUID();
      const title = typeof input.title === "string" ? input.title.trim() : "";
      if (!title) return null;
      const validColumns = new Set(columns.map(col => col.key));
      const column = validColumns.has(input.column) ? input.column : "planned";
      const priority = ["high", "medium", "low"].includes(input.priority) ? input.priority : "medium";
      const project = typeof input.project === "string" && input.project.trim() ? input.project.trim() : "Other";
      const notes = typeof input.notes === "string" ? input.notes : "";
      const dueDate = typeof input.dueDate === "string" ? input.dueDate : "";
      const createdAt = typeof input.createdAt === "string" ? input.createdAt : nowISO();
      const completedAt = column === "done"
        ? (typeof input.completedAt === "string" && input.completedAt ? input.completedAt : nowISO())
        : "";
      return { id, title, column, priority, project, notes, dueDate, createdAt, completedAt };
    }

    function normalizeActivity(input) {
      if (!input || typeof input !== "object") return null;
      const message = typeof input.message === "string" ? input.message.trim() : "";
      if (!message) return null;
      return {
        id: typeof input.id === "string" && input.id.trim() ? input.id : crypto.randomUUID(),
        message,
        ts: typeof input.ts === "string" && input.ts ? input.ts : nowISO()
      };
    }

    function loadData() {
      const stored = localStorage.getItem(STORAGE_KEY);
      const logStored = localStorage.getItem(LOG_KEY);
      const parsedTasks = safeParse(stored, null);
      const parsedActivity = safeParse(logStored, []);
      let shouldReset = false;

      if (Array.isArray(parsedTasks)) {
        tasks = parsedTasks.map(normalizeTask).filter(Boolean);
      } else if (!stored) {
        tasks = seedTasks();
      } else {
        tasks = seedTasks();
        shouldReset = true;
      }
      activity = Array.isArray(parsedActivity)
        ? parsedActivity.map(normalizeActivity).filter(Boolean).slice(0, 50)
        : [];
      if (shouldReset) {
        activity.unshift({
          id: crypto.randomUUID(),
          message: "Stored data was invalid and has been reset.",
          ts: nowISO()
        });
      }
      persist();
    }

    function seedTasks() {
      const createdAt = nowISO();
      return [
        { id: crypto.randomUUID(), title: "Security audit completed", column: "done", priority: "high", project: "Infrastructure", notes: "", dueDate: "", createdAt, completedAt: createdAt },
        { id: crypto.randomUUID(), title: "Kanban Pro dashboard built", column: "done", priority: "high", project: "Infrastructure", notes: "", dueDate: "", createdAt, completedAt: createdAt },
        { id: crypto.randomUUID(), title: "Ollama installed with 3 models", column: "done", priority: "high", project: "Watson", notes: "", dueDate: "", createdAt, completedAt: createdAt },
        { id: crypto.randomUUID(), title: "Telegram gateway configured", column: "done", priority: "medium", project: "Watson", notes: "", dueDate: "", createdAt, completedAt: createdAt },
        { id: crypto.randomUUID(), title: "CoachFinder design system v2", column: "done", priority: "high", project: "CoachFinder", notes: "", dueDate: "", createdAt, completedAt: createdAt },
        { id: crypto.randomUUID(), title: "HubSpot integration complete", column: "done", priority: "high", project: "CoachFinder", notes: "", dueDate: "", createdAt, completedAt: createdAt },
        { id: crypto.randomUUID(), title: "Command Center v2", column: "active", priority: "high", project: "Infrastructure", notes: "", dueDate: "", createdAt, completedAt: "" },
        { id: crypto.randomUUID(), title: "Twitter/YouTube research workflow", column: "planned", priority: "medium", project: "Lead Intel", notes: "", dueDate: "", createdAt, completedAt: "" },
        { id: crypto.randomUUID(), title: "Fix bird CLI for Twitter access", column: "planned", priority: "low", project: "Lead Intel", notes: "", dueDate: "", createdAt, completedAt: "" },
        { id: crypto.randomUUID(), title: "CoachFinder full pipeline integration", column: "planned", priority: "high", project: "CoachFinder", notes: "", dueDate: "", createdAt, completedAt: "" },
        { id: crypto.randomUUID(), title: "Dashboard documentation", column: "planned", priority: "low", project: "Infrastructure", notes: "", dueDate: "", createdAt, completedAt: "" }
      ];
    }

    function persist() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
      localStorage.setItem(LOG_KEY, JSON.stringify(activity));
    }

    function logActivity(message) {
      const entry = { id: crypto.randomUUID(), message, ts: nowISO() };
      activity.unshift(entry);
      if (activity.length > 50) activity = activity.slice(0, 50);
      persist();
      renderActivity();
    }

    function formatDate(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return "";
      return d.toLocaleDateString(undefined, { month: "short", day: "numeric" });
    }

    function priorityColor(priority) {
      if (priority === "high") return "#ef4444";
      if (priority === "medium") return "#f59e0b";
      return "#22c55e";
    }

    function render() {
      const counts = {
        done: tasks.filter(t => t.column === "done").length,
        active: tasks.filter(t => t.column === "active").length,
        planned: tasks.filter(t => t.column === "planned").length
      };

      const total = tasks.length;
      const completion = total ? Math.round((counts.done / total) * 100) : 0;
      totalCountEl.textContent = total;
      completionPctEl.textContent = `${completion}%`;
      doneCountEl.textContent = counts.done;
      activeCountEl.textContent = counts.active;
      plannedCountEl.textContent = counts.planned;
      progressBarEl.style.width = `${completion}%`;

      columnsEl.innerHTML = "";

      columns.forEach(col => {
        const colTasks = tasks.filter(t => t.column === col.key);
        const columnEl = document.createElement("section");
        columnEl.className = "column";

        const shell = document.createElement("div");
        shell.className = "column-shell";

        const header = document.createElement("div");
        header.className = "column-header";
        header.innerHTML = `
          <div class="column-title">${col.icon} ${col.title}</div>
          <span class="badge">${colTasks.length}</span>
        `;

        if (col.key === "done" && isMobile() && doneCollapsed) {
          const collapsed = document.createElement("div");
          collapsed.className = "done-collapsed";
          collapsed.innerHTML = `<span>Done collapsed</span><span class="badge">${colTasks.length}</span>`;
          collapsed.addEventListener("click", () => {
            doneCollapsed = false;
            render();
          });
          shell.appendChild(header);
          shell.appendChild(collapsed);
        } else {
          header.addEventListener("click", () => {
            if (col.key === "done" && isMobile()) {
              doneCollapsed = !doneCollapsed;
              render();
            }
          });
          shell.appendChild(header);
          colTasks.forEach((task, idx) => {
            const card = document.createElement("div");
            card.className = "card";
            card.tabIndex = 0;
            card.setAttribute("role", "button");
            card.setAttribute("aria-label", `Edit task ${task.title}`);
            card.style.borderLeftColor = priorityColor(task.priority);
            card.style.animationDelay = `${Math.min(idx * 40, 160)}ms`;
            const due = task.dueDate ? `Due ${formatDate(task.dueDate)}` : "";
            const titleEl = document.createElement("h4");
            titleEl.textContent = task.title;

            const metaEl = document.createElement("div");
            metaEl.className = "meta";
            const projectEl = document.createElement("span");
            projectEl.className = "pill";
            projectEl.textContent = task.project;
            const priorityEl = document.createElement("span");
            priorityEl.className = "pill";
            priorityEl.textContent = task.priority;
            metaEl.appendChild(projectEl);
            metaEl.appendChild(priorityEl);
            if (due) {
              const dueEl = document.createElement("span");
              dueEl.className = "pill";
              dueEl.textContent = due;
              metaEl.appendChild(dueEl);
            }

            card.appendChild(titleEl);
            card.appendChild(metaEl);
            card.addEventListener("click", () => openModal(task.id));
            card.addEventListener("keydown", e => {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                openModal(task.id);
              }
            });
            shell.appendChild(card);
          });
        }

        const addBtn = document.createElement("button");
        addBtn.className = "add-btn";
        addBtn.innerHTML = "+ Add Card";
        addBtn.addEventListener("click", () => openModal(null, col.key));
        shell.appendChild(addBtn);

        columnEl.appendChild(shell);
        columnsEl.appendChild(columnEl);
      });

      if (isMobile()) {
        const index = columns.findIndex(c => c.key === activeTab);
        columnsEl.style.transform = `translateX(-${index * 100}%)`;
      } else {
        columnsEl.style.transform = "none";
      }

      document.querySelectorAll(".tab").forEach(tab => {
        tab.classList.toggle("active", tab.dataset.tab === activeTab);
      });
    }

    function renderActivity() {
      activityList.innerHTML = "";
      if (!activity.length) {
        const empty = document.createElement("div");
        empty.className = "activity-item";
        empty.textContent = "No activity yet.";
        activityList.appendChild(empty);
        return;
      }
      activity.forEach(entry => {
        const item = document.createElement("div");
        item.className = "activity-item";
        const when = new Date(entry.ts).toLocaleString();
        const strong = document.createElement("strong");
        strong.textContent = entry.message;
        const time = document.createElement("span");
        time.textContent = when;
        item.appendChild(strong);
        item.appendChild(time);
        activityList.appendChild(item);
      });
    }

    function openModal(id, presetColumn) {
      editingId = id;
      if (id) {
        const task = tasks.find(t => t.id === id);
        if (!task) return;
        modalTitle.textContent = "Edit Task";
        taskTitle.value = task.title;
        const projectValue = task.project || "Other";
        taskProject.value = Array.from(taskProject.options).some(option => option.value === projectValue)
          ? projectValue
          : "Other";
        taskDue.value = task.dueDate || "";
        taskNotes.value = task.notes || "";
        taskColumn.value = task.column;
        document.querySelectorAll("input[name='priority']").forEach(r => {
          r.checked = r.value === task.priority;
        });
        deleteBtn.style.display = "inline-flex";
      } else {
        modalTitle.textContent = "Add Task";
        taskTitle.value = "";
        taskProject.value = "Infrastructure";
        taskDue.value = "";
        taskNotes.value = "";
        taskColumn.value = presetColumn || activeTab;
        document.querySelectorAll("input[name='priority']").forEach(r => {
          r.checked = r.value === "medium";
        });
        deleteBtn.style.display = "none";
      }
      modalBackdrop.classList.add("open");
      if (isMobile()) modal.classList.add("fullscreen");
      else modal.classList.remove("fullscreen");
      requestAnimationFrame(() => taskTitle.focus());
    }

    function closeModal() {
      modalBackdrop.classList.remove("open");
      editingId = null;
    }

    function saveTask() {
      const title = taskTitle.value.trim();
      if (!title) {
        taskTitle.focus();
        return;
      }
      const priority = document.querySelector("input[name='priority']:checked")?.value || "medium";
      const project = taskProject.value;
      const dueDate = taskDue.value;
      const notes = taskNotes.value;
      const column = columns.some(c => c.key === taskColumn.value) ? taskColumn.value : activeTab;

      if (editingId) {
        const task = tasks.find(t => t.id === editingId);
        if (!task) return;
        const prevColumn = task.column;
        task.title = title;
        task.priority = priority;
        task.project = project;
        task.notes = notes;
        task.dueDate = dueDate;
        task.column = column;
        if (column === "done" && !task.completedAt) task.completedAt = nowISO();
        if (column !== "done") task.completedAt = "";
        logActivity(`Edited: ${task.title}`);
        if (prevColumn !== column) {
          logActivity(`Moved: ${task.title} ‚Üí ${column}`);
        }
      } else {
        const newTask = {
          id: crypto.randomUUID(),
          title,
          column,
          priority,
          project,
          notes,
          dueDate,
          createdAt: nowISO(),
          completedAt: column === "done" ? nowISO() : ""
        };
        tasks.unshift(newTask);
        logActivity(`Added: ${newTask.title}`);
      }
      persist();
      render();
      closeModal();
    }

    function deleteTask() {
      if (!editingId) return;
      const task = tasks.find(t => t.id === editingId);
      if (!task) return;
      tasks = tasks.filter(t => t.id !== editingId);
      logActivity(`Deleted: ${task.title}`);
      persist();
      render();
      closeModal();
    }

    function isMobile() {
      return window.matchMedia("(max-width: 719px)").matches;
    }

    function initTabs() {
      document.querySelectorAll(".tab").forEach(tab => {
        tab.addEventListener("click", () => {
          activeTab = tab.dataset.tab;
          render();
        });
      });
    }

    function initSwipe() {
      let startX = 0;
      let endX = 0;
      let dragging = false;

      columnsEl.addEventListener("touchstart", e => {
        if (!isMobile()) return;
        startX = e.touches[0].clientX;
        endX = startX;
        dragging = true;
      }, { passive: true });

      columnsEl.addEventListener("touchmove", e => {
        if (!dragging || !isMobile()) return;
        endX = e.touches[0].clientX;
      }, { passive: true });

      columnsEl.addEventListener("touchend", () => {
        if (!dragging || !isMobile()) return;
        const diff = endX - startX;
        if (Math.abs(diff) > 50) {
          const index = columns.findIndex(c => c.key === activeTab);
          const nextIndex = diff < 0 ? index + 1 : index - 1;
          if (columns[nextIndex]) {
            activeTab = columns[nextIndex].key;
            render();
          }
        }
        dragging = false;
        endX = 0;
      });

      columnsEl.addEventListener("touchcancel", () => {
        dragging = false;
        endX = 0;
      });
    }

    function initTheme() {
      const stored = localStorage.getItem(THEME_KEY);
      const theme = stored === "light" || stored === "dark" ? stored : "dark";
      document.documentElement.dataset.theme = theme;
      document.body.dataset.theme = theme;
      document.getElementById("themeToggle").addEventListener("click", () => {
        const next = document.documentElement.dataset.theme === "dark" ? "light" : "dark";
        document.documentElement.dataset.theme = next;
        document.body.dataset.theme = next;
        localStorage.setItem(THEME_KEY, next);
      });
    }

    function initMenu() {
      document.getElementById("menuToggle").addEventListener("click", () => {
        menuPanel.classList.toggle("open");
      });
      document.addEventListener("click", e => {
        if (!e.target.closest(".menu")) menuPanel.classList.remove("open");
      });
      document.getElementById("exportBtn").addEventListener("click", () => {
        const payload = { tasks, activity };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "command-center-v2.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        logActivity("Exported JSON snapshot");
        menuPanel.classList.remove("open");
      });
      document.getElementById("importBtn").addEventListener("click", () => {
        importFile.value = "";
        importFile.click();
        menuPanel.classList.remove("open");
      });
      importFile.addEventListener("change", e => {
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const parsed = JSON.parse(reader.result);
            if (!parsed.tasks || !Array.isArray(parsed.tasks)) throw new Error("Invalid");
            const confirmReplace = confirm("Import will replace current data. Continue?");
            if (!confirmReplace) return;
            tasks = parsed.tasks.map(normalizeTask).filter(Boolean);
            if (!tasks.length) throw new Error("Invalid");
            activity = Array.isArray(parsed.activity)
              ? parsed.activity.map(normalizeActivity).filter(Boolean).slice(0, 50)
              : [];
            logActivity(`Imported ${tasks.length} task${tasks.length === 1 ? "" : "s"}`);
            persist();
            render();
            renderActivity();
          } catch (err) {
            alert("Invalid JSON file.");
          }
        };
        reader.readAsText(file);
      });
    }

    function initModal() {
      document.getElementById("modalClose").addEventListener("click", closeModal);
      modalBackdrop.addEventListener("click", e => {
        if (e.target === modalBackdrop) closeModal();
      });
      cancelBtn.addEventListener("click", closeModal);
      saveBtn.addEventListener("click", saveTask);
      deleteBtn.addEventListener("click", deleteTask);
      document.addEventListener("keydown", e => {
        if (e.key === "Escape") {
          if (modalBackdrop.classList.contains("open")) closeModal();
          if (activityPanel.classList.contains("open")) activityPanel.classList.remove("open");
          menuPanel.classList.remove("open");
        }
      });
    }

    function initActivityPanel() {
      document.getElementById("activityToggle").addEventListener("click", () => {
        activityPanel.classList.add("open");
      });
      document.getElementById("activityClose").addEventListener("click", () => {
        activityPanel.classList.remove("open");
      });
    }

    function initResize() {
      window.addEventListener("resize", () => {
        render();
      });
    }

    function initServiceWorker() {
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("sw.js").catch(err => {
          console.error("Service worker registration failed", err);
        });
      }
    }

    loadData();
    initTheme();
    initTabs();
    initSwipe();
    initMenu();
    initModal();
    initActivityPanel();
    initResize();
    render();
    renderActivity();
    initServiceWorker();
  </script>
</body>
</html>
