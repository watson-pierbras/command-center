<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Command Center</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0f1117;
      --surface: #1a1d2e;
      --card: #222639;
      --border: #2d3154;
      --shell-bg: #1d2236;
      --chip-bg: #2d3154;
      --chip-border: #3b4270;
      --soft-accent-bg: rgba(99, 102, 241, 0.1);
      --text: #e2e8f0;
      --text-secondary: #94a3b8;
      --accent: #4f46e5;
      --success: #22c55e;
      --warn: #f59e0b;
      --danger: #ef4444;
      --shadow: 0 10px 20px rgba(0, 0, 0, 0.25);
      --radius: 14px;
      --radius-lg: 18px;
    }

    [data-theme="light"] {
      --bg: #F8F7F5;
      --surface: #ffffff;
      --card: #ffffff;
      --border: #e2e8f0;
      --shell-bg: #ffffff;
      --chip-bg: #f1f5f9;
      --chip-border: #cbd5e1;
      --soft-accent-bg: rgba(79, 70, 229, 0.12);
      --text: #0f172a;
      --text-secondary: #334155;
      --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 12px rgba(0,0,0,0.04);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      background: radial-gradient(1200px 600px at 10% -10%, rgba(99, 102, 241, 0.2), transparent 55%),
                  radial-gradient(900px 500px at 90% 0%, rgba(34, 197, 94, 0.12), transparent 60%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
      transition: background 0.2s ease, color 0.2s ease;
    }

    body[data-theme='light'] {
      background: radial-gradient(1200px 600px at 10% -10%, rgba(79, 70, 229, 0.16), transparent 55%),
                  radial-gradient(900px 500px at 90% 0%, rgba(34, 197, 94, 0.12), transparent 60%),
                  var(--bg);
    }

    .app {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 15;
      background: linear-gradient(180deg, rgba(15, 17, 23, 0.92), rgba(15, 17, 23, 0.82));
      backdrop-filter: blur(14px);
      border-bottom: 1px solid var(--border);
      padding: 14px 16px 12px;
      display: grid;
      gap: 16px;
    }

    body[data-theme='light'] header {
      background: linear-gradient(180deg, rgba(248, 250, 252, 0.94), rgba(248, 250, 252, 0.88));
    }

    .top-row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    .title-wrap {
      display: grid;
      gap: 4px;
    }

    .title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.2px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-updated {
      font-size: 11px;
      color: var(--text-secondary);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
      min-height: 18px;
    }

    .sync-flash {
      opacity: 0;
      transform: translateY(-2px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      pointer-events: none;
      font-size: 11px;
    }

    .sync-flash.show {
      opacity: 1;
      transform: translateY(0);
    }

    .sync-flash.ok { color: #22c55e; }
    .sync-flash.warn { color: #f59e0b; }

    .muted-note {
      margin: 0;
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    .settings-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .icon-btn {
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    }

    .icon-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .stats {
      display: grid;
      gap: 16px;
    }

    .stats-row {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      color: var(--text-secondary);
      flex-wrap: wrap;
    }

    .stats-row strong { color: var(--text); }

    .stats-strip {
      font-weight: 600;
      align-items: center;
      gap: 0;
    }

    .stats-strip span {
      display: inline-flex;
      align-items: center;
    }

    .stats-strip span + span::before {
      content: "·";
      margin: 0 8px;
      color: var(--text-secondary);
    }

    .stats-support {
      font-size: 12px;
      gap: 10px;
    }

    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .progress {
      width: 100%;
      height: 6px;
      background: var(--border);
      border-radius: 999px;
      overflow: hidden;
    }

    .progress > span {
      display: block;
      height: 100%;
      border-radius: 999px;
      transition: width 0.3s ease;
    }

    #progressBar {
      background: linear-gradient(90deg, #22c55e 0%, #22c55e 60%, #3b82f6 100%);
      border-radius: inherit;
      position: relative;
    }

    #progressBar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: inherit;
    }

    .desktop-tabs {
      display: none;
      gap: 8px;
      align-items: center;
    }

    .tab-btn {
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-secondary);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .tab-btn.active {
      background: var(--accent);
      color: #ffffff;
      border-color: var(--accent);
    }

    main {
      flex: 1;
      padding: 20px 14px 90px;
      overflow: hidden;
    }

    .tab-panels {
      position: relative;
      min-height: 100%;
    }

    .panel {
      display: none;
      opacity: 0;
    }

    .panel.active {
      display: block;
    }

    .panel.fade-in {
      opacity: 1;
      transition: opacity 150ms ease;
    }

    .board-subtabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      overflow-x: auto;
      padding-bottom: 2px;
    }

    .board-subtab {
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-secondary);
      border-radius: 999px;
      padding: 8px 11px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
      cursor: pointer;
    }

    .board-subtab.active {
      background: var(--accent);
      color: #ffffff;
      border-color: var(--accent);
    }

    .columns {
      display: flex;
      transition: transform 0.35s ease;
      will-change: transform;
    }

    .column {
      min-width: 100%;
      padding: 6px 4px 16px;
    }

    .column-shell {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 240px;
      transition: background 0.2s ease, border-color 0.2s ease;
    }

    body[data-theme='light'] .column-shell {
      background: var(--shell-bg);
    }

    .column-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      font-weight: 600;
    }

    .column-title {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
      flex-shrink: 0;
    }

    .status-indicator.done { background: #22c55e; }
    .status-indicator.active { background: #3b82f6; }
    .status-indicator.planned { background: #f59e0b; }

    .badge {
      background: var(--chip-bg);
      border: 1px solid var(--chip-border);
      color: var(--text);
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-left: 4px solid var(--accent);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      cursor: pointer;
      transition: box-shadow 150ms ease, transform 150ms ease;
      animation: fadeInUp 0.35s ease both;
      color: var(--text);
      opacity: 1;
    }

    .card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transform: translateY(-1px);
    }

    [data-theme='light'] .card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .card:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .card h4 {
      margin: 0 0 8px;
      font-size: 15px;
      color: var(--text);
      font-weight: 700;
    }

    [data-theme='light'] .card h4 { color: #0f172a; font-weight: 700; }

    body[data-theme='light'] .card {
      border-color: #cbd5e1;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 12px rgba(0,0,0,0.04);
    }

    .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .card .card-detail-only { display: none; }

    .pill {
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--chip-bg);
      border: 1px solid var(--chip-border);
      color: var(--text);
      font-size: 11px;
      font-weight: 600;
    }

    .pill.priority-high { background: rgba(34, 197, 94, 0.15); color: #22c55e; border-color: rgba(34, 197, 94, 0.3); }
    .pill.priority-medium { background: rgba(245, 158, 11, 0.15); color: #f59e0b; border-color: rgba(245, 158, 11, 0.3); }
    .pill.priority-low { background: rgba(148, 163, 184, 0.15); color: #94a3b8; border-color: rgba(148, 163, 184, 0.3); }

    [data-theme="light"] .pill.priority-high { background: rgba(34, 197, 94, 0.1); color: #16a34a; border-color: rgba(34, 197, 94, 0.25); }
    [data-theme="light"] .pill.priority-medium { background: rgba(245, 158, 11, 0.1); color: #d97706; border-color: rgba(245, 158, 11, 0.25); }
    [data-theme="light"] .pill.priority-low { background: rgba(148, 163, 184, 0.1); color: #64748b; border-color: rgba(148, 163, 184, 0.25); }

    [data-theme='light'] .meta .chip { background: #e2e8f0; color: #334155; border-color: #94a3b8; }

    .agent-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--chip-border);
      background: var(--soft-accent-bg);
      color: var(--text);
      font-size: 11px;
      font-weight: 700;
    }

    .agent-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 4px;
      flex-shrink: 0;
    }

    .agent-dot.watson { background: #6366f1; }
    .agent-dot.codex { background: #22c55e; }
    .agent-dot.ollama { background: #f59e0b; }

    .agent-name {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-weight: 700;
    }

    .add-btn {
      margin-top: auto;
      border: 1px dashed rgba(148, 163, 184, 0.35);
      background: transparent;
      color: rgba(148, 163, 184, 0.88);
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: border-color 0.2s ease, color 0.2s ease, background 0.2s ease, transform 150ms ease;
    }

    .add-btn:hover { border-color: rgba(79, 70, 229, 0.45); color: var(--text); background: rgba(79, 70, 229, 0.08); }
    .add-btn:hover { transform: translateY(-1px); }

    .done-collapsed {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      cursor: pointer;
      background: var(--soft-accent-bg);
      color: var(--text-secondary);
      font-weight: 700;
    }

    .grid-two {
      display: grid;
      gap: 12px;
    }

    .agents-stack {
      grid-template-columns: 1fr !important;
    }

    .agent-card,
    .cost-card,
    .breakdown-shell,
    .feed-shell {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 14px;
    }

    .agent-card.online {
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.32), 0 0 20px rgba(34, 197, 94, 0.18);
    }

    .agent-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 700;
      text-transform: capitalize;
    }

    .status-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      display: inline-block;
    }

    .status-dot.online { background: var(--success); }
    .status-dot.idle { background: var(--warn); }
    .status-dot.offline { background: var(--danger); }

    .agent-kv {
      display: grid;
      gap: 6px;
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }

    .agent-kv strong { color: var(--text); }

    .task-list {
      display: grid;
      gap: 6px;
    }

    .task-line {
      font-size: 12px;
      border: 1px solid var(--border);
      background: var(--card);
      padding: 8px;
      border-radius: 10px;
      color: var(--text);
      font-weight: 600;
    }

    .cost-summary {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 12px;
    }

    .cost-card .value {
      font-size: 24px;
      font-weight: 700;
      color: var(--text);
    }

    .cost-card .label {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: none;
      letter-spacing: 0.04em;
    }

    .cost-card .subvalue {
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-secondary);
      font-weight: 600;
    }

    .cost-card.cost-warn {
      border-color: var(--warn);
    }

    .cost-card.cost-warn .value {
      color: var(--warn);
    }

    .cost-card.cost-danger {
      border-color: var(--danger);
    }

    .cost-card.cost-danger .value {
      color: var(--danger);
    }

    .sparkline-chart {
      display: flex;
      align-items: flex-end;
      gap: 4px;
      height: 80px;
      padding: 8px 0;
    }

    .spark-bar-wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      height: 100%;
      justify-content: flex-end;
      cursor: default;
    }

    .spark-bar {
      width: 100%;
      max-width: 32px;
      background: var(--accent);
      border-radius: 3px 3px 0 0;
      min-height: 3px;
      transition: opacity 150ms ease;
    }

    .spark-bar-wrap:hover .spark-bar {
      opacity: 0.7;
    }

    .spark-label {
      font-size: 10px;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .cost-filters {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 12px 0;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .filter-group select {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 13px;
    }

    .segmented-control {
      display: inline-flex;
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
    }

    .seg-btn {
      background: transparent;
      color: var(--text-secondary);
      border: none;
      padding: 4px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      border-right: 1px solid var(--border);
    }

    .seg-btn:last-child {
      border-right: none;
    }

    .seg-btn.active {
      background: var(--accent);
      color: #fff;
    }

    .model-bars {
      display: grid;
      gap: 10px;
      margin-top: 6px;
    }

    .model-bar-row {
      display: grid;
      gap: 4px;
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 700;
    }

    .model-bar-main {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      color: var(--text);
      font-size: 13px;
    }

    .model-bar-main strong {
      font-weight: 700;
      color: var(--text);
    }

    .model-bar-meta {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 11px;
      color: var(--text-secondary);
    }

    .model-meta-pill {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      border: 1px solid var(--chip-border);
      background: var(--chip-bg);
      border-radius: 999px;
      padding: 3px 8px;
      font-weight: 600;
    }

    .model-meta-pill.cache {
      border-color: rgba(99, 102, 241, 0.38);
      background: rgba(99, 102, 241, 0.14);
      color: #c7d2fe;
    }

    body[data-theme='light'] .model-meta-pill.cache {
      color: #4338ca;
      border-color: rgba(67, 56, 202, 0.3);
      background: rgba(67, 56, 202, 0.1);
    }

    .bar-track {
      height: 10px;
      background: var(--chip-bg);
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid var(--chip-border);
    }

    .bar-fill {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, var(--accent), #06b6d4);
      border-radius: 999px;
      animation: growBar 0.8s ease forwards;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 10px;
    }

    th,
    td {
      padding: 8px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      color: var(--text);
      font-weight: 600;
    }

    th {
      color: var(--text-secondary);
      text-transform: none;
      letter-spacing: 0.04em;
      font-size: 11px;
    }

    .table-wrap {
      overflow-x: auto;
    }

    .feed-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 700;
    }

    .timeline {
      display: grid;
      gap: 10px;
      max-height: 62vh;
      overflow-y: auto;
      padding-right: 4px;
    }

    .timeline-item {
      border: 1px solid var(--border);
      background: var(--card);
      border-left: 4px solid var(--accent);
      border-radius: 12px;
      padding: 10px;
    }

    .timeline-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 700;
    }

    .timeline-text {
      font-size: 14px;
      color: var(--text);
      font-weight: 600;
      margin: 0 0 4px;
    }

    .timeline-detail {
      font-size: 12px;
      color: var(--text-secondary);
      word-break: break-word;
      margin: 0;
    }

    .feed-info { border-left-color: #3b82f6; }
    .feed-success { border-left-color: #22c55e; }
    .feed-warning { border-left-color: #f59e0b; }
    .feed-error { border-left-color: #ef4444; }
    .feed-message { border-left-color: #14b8a6; }

    .pipeline-shell {
      display: grid;
      gap: 12px;
    }

    .pipeline-progress {
      display: grid;
      gap: 10px;
    }

    .pipeline-progress-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 700;
    }

    .pipeline-progress-row strong { color: var(--text); }

    .pipeline-progress-track {
      width: 100%;
      height: 10px;
      border: 1px solid var(--chip-border);
      border-radius: 999px;
      overflow: hidden;
      background: var(--chip-bg);
    }

    .pipeline-progress-fill {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, #22c55e, #06b6d4);
      border-radius: 999px;
      animation: growBar 0.8s ease forwards;
    }

    .pipeline-stats {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .pipeline-project-list {
      display: grid;
      gap: 10px;
    }

    .pipeline-project-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 16px;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .pipeline-project-card:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .pipeline-project-card .project-title {
      font-weight: 700;
      font-size: 14px;
      margin-bottom: 6px;
    }

    .pipeline-project-card .project-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .pipeline-project-card .project-notes {
      font-size: 13px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .pipeline-project-card .project-footer {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 8px;
    }

    .pipeline-project-card.done {
      opacity: 0.7;
    }

    .pipeline-project-card.done .project-title {
      text-decoration: line-through;
      text-decoration-color: var(--text-secondary);
    }

    .tabbar-mobile {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: stretch;
      gap: 8px;
      padding: 8px 10px 12px;
      z-index: 20;
    }

    .tab-mobile {
      flex: 1 1 0;
      min-width: 0;
      text-align: center;
      padding: 8px 2px;
      border-radius: 10px;
      font-size: 13px;
      border: 1px solid transparent;
      color: var(--text-secondary);
      cursor: pointer;
      transition: color 0.2s ease, background 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .tab-mobile.active {
      background: var(--accent);
      color: #ffffff;
      border-color: var(--accent);
    }

    .menu {
      position: relative;
    }

    .menu-panel {
      position: absolute;
      right: 0;
      top: 42px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 6px;
      min-width: 170px;
      box-shadow: var(--shadow);
      display: none;
      z-index: 40;
    }

    .menu-panel.open { display: block; }

    .menu-panel button {
      width: 100%;
      border: none;
      background: transparent;
      color: var(--text);
      padding: 8px 10px;
      text-align: left;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    .menu-panel button:hover { background: rgba(99, 102, 241, 0.12); }

    .activity-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 320px;
      max-width: 92vw;
      height: 100vh;
      background: var(--surface);
      border-left: 1px solid var(--border);
      transform: translateX(100%);
      opacity: 0;
      transition: transform 250ms cubic-bezier(0.4, 0, 0.2, 1), opacity 250ms ease;
      z-index: 30;
      padding: 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .activity-panel.open,
    .activity-panel.mobile-open {
      transform: translateX(0);
      opacity: 1;
    }

    .activity-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-y: auto;
      padding-right: 6px;
    }

    .activity-item {
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 12px;
      padding: 10px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .activity-item strong { color: var(--text); display: block; margin-bottom: 4px; }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    .modal-backdrop.open {
      opacity: 1;
      pointer-events: auto;
    }

    .settings-overlay {
      transition: opacity 200ms ease;
    }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      width: min(560px, 94vw);
      max-height: 92vh;
      overflow-y: auto;
      padding: 16px;
      animation: modalIn 0.25s ease;
    }

    .modal.fullscreen {
      width: 100vw;
      height: 100vh;
      border-radius: 0;
      max-height: 100vh;
    }

    .modal h3 { margin: 0 0 10px; }

    .card-detail-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.58);
      display: flex;
      justify-content: flex-end;
      z-index: 52;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.22s ease;
    }

    .card-detail-backdrop.open {
      opacity: 1;
      pointer-events: auto;
    }

    .card-detail,
    .card-detail-panel {
      width: min(600px, 100vw);
      height: 100vh;
      background: var(--surface);
      border-left: 1px solid var(--border);
      transform: translateX(100%);
      transition: transform 250ms cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .card-detail-backdrop.open .card-detail {
      transform: translateX(0);
    }

    .card-detail-header {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 14px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
    }

    .card-detail-head-main {
      min-width: 0;
      flex: 1;
      display: grid;
      gap: 8px;
    }

    .card-detail-head-main h2 {
      margin: 0;
      font-size: 22px;
      line-height: 1.2;
      word-break: break-word;
    }

    .card-detail-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 0 14px 14px;
      display: grid;
      gap: 12px;
    }

    .card-detail-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding-top: 12px;
    }

    .card-detail-meta .pill {
      background: var(--chip-bg);
      border: 1px solid var(--chip-border);
      padding: 4px 10px;
      font-weight: 600;
    }

    .card-detail-section {
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 12px;
      padding: 12px;
      display: grid;
      gap: 8px;
    }

    .card-detail-section h3,
    .card-detail-panel h3 {
      margin: 0;
      text-transform: none;
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text);
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
      margin-bottom: 12px;
      letter-spacing: 0;
    }

    .card-detail-section > h4,
    .card-detail .card-detail-section h4,
    #cardDetail .card-detail-section h4 {
      margin: 0;
      text-transform: none !important;
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text);
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
      margin-bottom: 12px;
      letter-spacing: 0;
    }

    .detail-notes {
      margin: 0;
      white-space: pre-wrap;
      font-size: 14px;
      color: var(--text);
      line-height: 1.5;
    }

    .attachments-list {
      display: grid;
      gap: 6px;
      margin: 0;
      padding: 0;
      list-style: none;
    }

    .attachments-list a {
      color: var(--text);
      text-decoration: none;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      background: var(--surface);
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .comment-list {
      display: grid;
      gap: 8px;
    }

    .comment-bubble {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      background: var(--surface);
      display: grid;
      gap: 6px;
    }

    .comment-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 700;
    }

    .comment-text {
      margin: 0;
      font-size: 13px;
      color: var(--text);
      white-space: pre-wrap;
      word-break: break-word;
    }

    .history-list {
      display: grid;
      gap: 8px;
      margin-top: 8px;
    }

    .history-item {
      border-left: 2px solid var(--chip-border);
      padding-left: 10px;
      font-size: 12px;
      color: var(--text-secondary);
      display: grid;
      gap: 3px;
    }

    .history-item strong {
      color: var(--text);
      font-size: 13px;
    }

    .detail-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .comment-input {
      border-top: 1px solid var(--border);
      padding: 10px 14px max(14px, env(safe-area-inset-bottom));
      display: flex;
      align-items: flex-end;
      gap: 8px;
      background: var(--surface);
    }

    .comment-input textarea,
    .card-detail-panel textarea {
      flex: 1;
      min-width: 0;
      background: var(--chip-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      font-size: 0.875rem;
      color: var(--text);
      resize: vertical;
      min-height: 60px;
      transition: border-color 200ms ease;
    }

    .comment-input textarea:focus,
    .card-detail-panel textarea:focus {
      border-color: var(--accent);
      outline: none;
    }

    .empty-state-text {
      color: var(--text-secondary);
      font-style: italic;
      opacity: 0.7;
      padding: 16px 0;
    }

    .form-grid {
      display: grid;
      gap: 12px;
    }

    .form-row-2 {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(1, minmax(0, 1fr));
    }

    label { font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px; font-weight: 700; }

    input,
    select,
    textarea {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
    }

    textarea { min-height: 80px; resize: vertical; }

    .radio-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .radio-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 700;
    }

    .radio-pill input { width: auto; }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      display: inline-block;
    }

    .modal-actions {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 8px;
    }

    .btn {
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
    }

    .btn.primary { background: var(--accent); color: white; }
    .btn.secondary { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .btn.danger { background: #ef4444; color: white; }

    .close-btn {
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 20px;
      cursor: pointer;
    }

    @keyframes fadeInUp {
      from { opacity: 0.5; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeSlide {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes modalIn {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes growBar {
      from { width: 0; }
      to { width: var(--bar-width, 0%); }
    }

    @media (min-width: 720px) {
      main { padding: 20px 18px 24px; }
      .desktop-tabs { display: inline-flex; }
      .tabbar-mobile { display: none; }
      .board-subtabs { display: none; }
      .columns {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        transform: none !important;
      }
      .column { min-width: auto; }
      .cost-summary { grid-template-columns: repeat(4, minmax(0, 1fr)); }
      .grid-two { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .form-row-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    @media (max-width: 599px) {
      table th[data-col="note"],
      table td[data-col="note"] {
        display: none;
      }
    }

    @media (max-width: 719px) {
      .cost-summary { grid-template-columns: repeat(2, minmax(0, 1fr)); }

      .activity-panel {
        display: none;
        width: 100vw;
        max-width: 100vw;
        border-left: none;
      }

      .activity-panel.mobile-open {
        display: flex;
        transform: translateX(0);
        opacity: 1;
      }

      .card-detail {
        width: 100vw;
        border-left: none;
      }

      .card-detail-header {
        padding-top: max(14px, env(safe-area-inset-top));
      }
    }

    @media (min-width: 1024px) {
      .columns { grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 16px; }
      .grid-two { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    .card:focus-visible,
    .add-btn:focus-visible,
    .icon-btn:focus-visible,
    .btn:focus-visible,
    .tab-btn:focus-visible,
    .tab-mobile:focus-visible,
    .board-subtab:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="top-row">
        <div class="title-wrap">
          <div class="title">Command Center</div>
          <div class="header-updated">
            <span id="syncUpdated">Last updated: never</span>
            <span class="sync-flash" id="githubWriteStatus" aria-live="polite"></span>
          </div>
        </div>
        <div class="header-actions">
          <button class="icon-btn" id="themeToggle" title="Toggle theme">◐</button>
          <button class="icon-btn" id="refreshBtn" title="Refresh state">↻</button>
          <div class="menu">
            <button class="icon-btn" id="menuToggle" title="Menu">⋮</button>
            <div class="menu-panel" id="menuPanel">
              <button id="exportBtn">Export JSON</button>
              <button id="importBtn">Import JSON</button>
              <button id="settingsBtn">Settings</button>
            </div>
          </div>
        </div>
      </div>
      <div class="stats">
        <div class="stats-row stats-strip">
          <span class="visually-hidden">Total <strong id="totalCount">0</strong></span>
          <span><strong id="completionPct">0%</strong>&nbsp;complete</span>
          <span><strong id="doneCount">0</strong>&nbsp;done</span>
          <span><strong id="activeCount">0</strong>&nbsp;active</span>
          <span><strong id="plannedCount">0</strong>&nbsp;planned</span>
        </div>
        <div class="progress"><span id="progressBar" style="width:0%"></span></div>
        <div class="stats-row stats-support">
          <span>Remaining <strong id="remainingEstimate">0</strong></span>
          <span>State source: <strong id="stateSource">Demo fallback</strong></span>
          <span>Updated <strong id="lastUpdated">-</strong></span>
        </div>
      </div>
      <nav class="desktop-tabs" id="desktopTabs" aria-label="Main tabs">
        <button class="tab-btn active" data-tab="board">Board</button>
        <button class="tab-btn" data-tab="agents">Agents</button>
        <button class="tab-btn" data-tab="costs">Costs</button>
        <button class="tab-btn" data-tab="pipeline">Pipeline</button>
        <button class="tab-btn" data-tab="feed">Feed</button>
      </nav>
    </header>

    <main>
      <div class="tab-panels">
        <section class="panel active" id="panel-board">
          <div class="board-subtabs" id="boardSubtabs">
            <button class="board-subtab" data-column="done"><span class="status-indicator done"></span>Done</button>
            <button class="board-subtab active" data-column="active"><span class="status-indicator active"></span>Active</button>
            <button class="board-subtab" data-column="planned"><span class="status-indicator planned"></span>Planned</button>
          </div>
          <div class="columns" id="columns"></div>
        </section>

        <section class="panel" id="panel-agents">
          <div id="agentsContainer" class="grid-two agents-stack"></div>
        </section>

        <section class="panel" id="panel-costs">
          <div class="cost-summary" id="costSummary"></div>
          <div class="breakdown-shell">
            <div class="sparkline-section">
              <h3 style="margin:0 0 8px;">Daily Spend</h3>
              <div class="sparkline-chart" id="sparklineChart"></div>
            </div>
          </div>
          <div class="cost-filters" id="costFilters">
            <div class="filter-group">
              <label>Model</label>
              <select id="costModelFilter">
                <option value="all">All Models</option>
              </select>
            </div>
            <div class="filter-group">
              <div class="segmented-control" id="costDateRange">
                <button class="seg-btn active" data-range="48h">48h</button>
                <button class="seg-btn" data-range="7d">7d</button>
                <button class="seg-btn" data-range="30d">30d</button>
              </div>
            </div>
          </div>
          <div class="breakdown-shell">
            <h3 style="margin:0 0 8px;">Spend By Model</h3>
            <div class="model-bars" id="modelBars"></div>
          </div>
          <div class="project-spend-section" style="margin-top:12px;">
            <h3 style="margin:0 0 8px;">Spend by Project</h3>
            <div class="project-cards" id="projectCards"></div>
          </div>
          <div class="breakdown-shell" style="margin-top:12px;">
            <h3 style="margin:0 0 8px;">Cost Breakdown</h3>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr id="costTableHeadRow">
                    <th>Date</th>
                    <th>Agent</th>
                    <th>Model</th>
                    <th>Tokens In</th>
                    <th>Tokens Out</th>
                    <th>Cost</th>
                    <th data-col="note">Note</th>
                  </tr>
                </thead>
                <tbody id="costTableBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <section class="panel" id="panel-pipeline">
          <div class="pipeline-shell">
            <article class="breakdown-shell pipeline-progress">
              <div class="pipeline-progress-row">
                <span>Overall progress</span>
                <strong id="pipelineCompletion">55%</strong>
              </div>
              <div class="pipeline-progress-track">
                <div class="pipeline-progress-fill" id="pipelineProgressFill" style="--bar-width:55%"></div>
              </div>
              <div class="pipeline-stats" id="pipelineSummaryStats">
                <!-- Dynamically: Active: X, Planned: X, Done: X -->
              </div>
            </article>

            <article class="breakdown-shell">
              <h3 style="margin:0 0 12px;">Active</h3>
              <div id="pipelineActive" class="pipeline-project-list"></div>
            </article>

            <article class="breakdown-shell">
              <h3 style="margin:0 0 12px;">Planned</h3>
              <div id="pipelinePlanned" class="pipeline-project-list"></div>
            </article>

            <details class="breakdown-shell">
              <summary style="cursor:pointer; font-weight:600; margin-bottom:8px;">Recently Completed</summary>
              <div id="pipelineDone" class="pipeline-project-list"></div>
            </details>
          </div>
        </section>

        <section class="panel" id="panel-feed">
          <div class="feed-shell">
            <div class="feed-actions">
              <span>Timeline</span>
              <button class="btn secondary" id="feedRefreshBtn" type="button">Refresh Feed</button>
            </div>
            <div class="timeline" id="feedTimeline"></div>
          </div>
        </section>
      </div>
    </main>

    <nav class="tabbar-mobile" id="mobileTabs" aria-label="Main tabs mobile">
      <button class="tab-mobile active" data-tab="board">Board</button>
      <button class="tab-mobile" data-tab="agents">Agents</button>
      <button class="tab-mobile" data-tab="costs">Costs</button>
      <button class="tab-mobile" data-tab="pipeline">Pipeline</button>
      <button class="tab-mobile" data-tab="feed">Feed</button>
    </nav>

    <div class="activity-panel" id="activityPanel">
      <div class="top-row">
        <strong>Activity Log</strong>
        <button class="icon-btn" id="activityClose">✕</button>
      </div>
      <div class="activity-list" id="activityList"></div>
    </div>

    <div class="card-detail-backdrop" id="cardDetailBackdrop">
      <aside class="card-detail card-detail-panel" id="cardDetail" role="dialog" aria-modal="true" aria-labelledby="cardDetailTitle">
        <div class="card-detail-header">
          <button class="icon-btn" id="cardDetailBack" type="button" title="Back">←</button>
          <div class="card-detail-head-main">
            <span class="pill" id="cardDetailProject">Project</span>
            <h2 id="cardDetailTitle">Task Detail</h2>
          </div>
        </div>
        <div class="card-detail-scroll">
          <div class="card-detail-meta" id="cardDetailMeta"></div>
          <section class="card-detail-section">
            <h4>Notes</h4>
            <p class="detail-notes empty-state-text" id="cardDetailNotes">No notes yet. Add context, decisions, or links.</p>
          </section>
          <section class="card-detail-section">
            <h4>Attachments</h4>
            <ul class="attachments-list" id="cardDetailAttachments"></ul>
          </section>
          <section class="card-detail-section">
            <h4>Comments</h4>
            <div class="comment-list" id="cardDetailComments"></div>
          </section>
          <section class="card-detail-section">
            <details id="cardDetailHistoryToggle">
              <summary>History</summary>
              <div class="history-list" id="cardDetailHistory"></div>
            </details>
          </section>
          <section class="card-detail-section">
            <div class="detail-actions">
              <button class="btn secondary" id="cardDetailEditBtn" type="button">Edit</button>
              <button class="btn danger" id="cardDetailDeleteBtn" type="button">Delete</button>
            </div>
          </section>
        </div>
        <div class="comment-input">
          <textarea id="cardCommentInput" placeholder="Add a comment"></textarea>
          <button class="btn primary" id="cardCommentSendBtn" type="button">Send</button>
        </div>
      </aside>
    </div>

    <div class="modal-backdrop" id="modalBackdrop">
      <div class="modal" id="modal">
        <div class="top-row">
          <h3 id="modalTitle">Edit Task</h3>
          <button class="close-btn" id="modalClose">✕</button>
        </div>
        <div class="form-grid">
          <div>
            <label for="taskTitle">Title *</label>
            <input id="taskTitle" type="text" placeholder="Task title" required />
          </div>
          <div class="form-row-2">
            <div>
              <label for="taskProject">Project</label>
              <select id="taskProject">
                <option>CoachFinder</option>
                <option>Lead Intel</option>
                <option>Infrastructure</option>
                <option>Watson</option>
                <option>Other</option>
              </select>
            </div>
            <div>
              <label for="taskColumn">Column</label>
              <select id="taskColumn">
                <option value="done">Done</option>
                <option value="active">Active</option>
                <option value="planned">Planned</option>
              </select>
            </div>
          </div>
          <div>
            <label>Priority</label>
            <div class="radio-row">
              <label class="radio-pill"><input type="radio" name="priority" value="high" /> <span class="dot" style="background:#ef4444"></span> High</label>
              <label class="radio-pill"><input type="radio" name="priority" value="medium" /> <span class="dot" style="background:#f59e0b"></span> Medium</label>
              <label class="radio-pill"><input type="radio" name="priority" value="low" /> <span class="dot" style="background:#22c55e"></span> Low</label>
            </div>
          </div>
          <div class="form-row-2">
            <div>
              <label for="taskAgent">Assigned Agent</label>
              <select id="taskAgent">
                <option value="">Unassigned</option>
                <option value="watson">Watson</option>
                <option value="codex">Codex</option>
                <option value="ollama">Ollama</option>
              </select>
            </div>
            <div>
              <label for="taskModel">Model</label>
              <input id="taskModel" type="text" placeholder="gpt-5.3-codex" />
            </div>
          </div>
          <div class="form-row-2">
            <div>
              <label for="taskDue">Due Date</label>
              <input id="taskDue" type="date" />
            </div>
            <div>
              <label for="taskTime">Estimated Time</label>
              <input id="taskTime" type="text" placeholder="2h / 30m / 2d" />
            </div>
          </div>
          <div class="form-row-2">
            <div>
              <label for="taskCost">Estimated Cost (USD)</label>
              <input id="taskCost" type="number" min="0" step="0.01" placeholder="0.00" />
            </div>
          </div>
          <div>
            <label for="taskNotes">Notes</label>
            <textarea id="taskNotes" placeholder="Add context, links, notes"></textarea>
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn danger" id="deleteBtn">Delete</button>
          <div style="display:flex; gap:8px; margin-left:auto;">
            <button class="btn secondary" id="cancelBtn">Cancel</button>
            <button class="btn primary" id="saveBtn">Save</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-backdrop settings-overlay" id="settingsBackdrop">
      <div class="modal">
        <div class="top-row">
          <h3>GitHub Settings</h3>
          <button class="close-btn" id="settingsClose">✕</button>
        </div>
        <div class="form-grid">
          <p class="muted-note">Repo: <strong>watson-pierbras/command-center</strong></p>
          <div>
            <label for="githubPatInput">GitHub Personal Access Token (PAT)</label>
            <input id="githubPatInput" type="password" placeholder="github_pat_..." autocomplete="off" />
          </div>
          <div class="settings-row">
            <p class="muted-note" id="githubPatPreview">No token saved</p>
            <button class="btn secondary" id="githubPatClearBtn" type="button">Clear</button>
          </div>
          <div style="margin-top:16px; border-top:1px solid var(--border); padding-top:16px;">
            <h4 style="margin:0 0 8px;">Cost Budget</h4>
            <div class="form-grid">
              <div>
                <label for="budgetDailyInput">Daily Budget ($)</label>
                <input id="budgetDailyInput" type="number" step="0.01" placeholder="e.g. 100" />
              </div>
              <div>
                <label for="budgetMonthlyInput">Monthly Budget ($)</label>
                <input id="budgetMonthlyInput" type="number" step="0.01" placeholder="e.g. 500" />
              </div>
            </div>
          </div>
        </div>
        <div class="modal-actions">
          <div></div>
          <div style="display:flex; gap:8px; margin-left:auto;">
            <button class="btn secondary" id="settingsCancelBtn" type="button">Cancel</button>
            <button class="btn primary" id="settingsSaveBtn" type="button">Save</button>
          </div>
        </div>
      </div>
    </div>

    <input type="file" id="importFile" accept="application/json" style="display:none" />
  </div>

  <script>
    const STORAGE_KEY = "ccv2_tasks";
    const LOG_KEY = "ccv2_activity";
    const THEME_KEY = "ccv2_theme";
    const VERSION_KEY = "ccv2_version";
    const DATA_VERSION = "3.0";
    const GITHUB_PAT_KEY = "cc_github_pat";
    const GITHUB_REPO_OWNER = "watson-pierbras";
    const GITHUB_REPO_NAME = "command-center";

    const AGENT_META = {
      watson: { name: "Watson", dotClass: "watson", role: "Orchestrator", defaultModel: "claude-opus-4-6" },
      codex: { name: "Codex", dotClass: "codex", role: "Coding Agent", defaultModel: "gpt-5.3-codex" },
      ollama: { name: "Ollama", dotClass: "ollama", role: "Local LLMs", defaultModel: "qwen2.5-coder:3b" }
    };

    const columnsEl = document.getElementById("columns");
    const totalCountEl = document.getElementById("totalCount");
    const completionPctEl = document.getElementById("completionPct");
    const doneCountEl = document.getElementById("doneCount");
    const activeCountEl = document.getElementById("activeCount");
    const plannedCountEl = document.getElementById("plannedCount");
    const remainingEstimateEl = document.getElementById("remainingEstimate");
    const progressBarEl = document.getElementById("progressBar");
    const stateSourceEl = document.getElementById("stateSource");
    const lastUpdatedEl = document.getElementById("lastUpdated");
    const syncUpdatedEl = document.getElementById("syncUpdated");
    const githubWriteStatusEl = document.getElementById("githubWriteStatus");
    const activityPanel = document.getElementById("activityPanel");
    const activityList = document.getElementById("activityList");
    const menuPanel = document.getElementById("menuPanel");
    const importFile = document.getElementById("importFile");
    const settingsBackdrop = document.getElementById("settingsBackdrop");
    const settingsClose = document.getElementById("settingsClose");
    const settingsCancelBtn = document.getElementById("settingsCancelBtn");
    const settingsSaveBtn = document.getElementById("settingsSaveBtn");
    const settingsBtn = document.getElementById("settingsBtn");
    const githubPatInput = document.getElementById("githubPatInput");
    const githubPatPreview = document.getElementById("githubPatPreview");
    const githubPatClearBtn = document.getElementById("githubPatClearBtn");
    const budgetDailyInput = document.getElementById("budgetDailyInput");
    const budgetMonthlyInput = document.getElementById("budgetMonthlyInput");

    const modalBackdrop = document.getElementById("modalBackdrop");
    const modal = document.getElementById("modal");
    const modalTitle = document.getElementById("modalTitle");
    const taskTitle = document.getElementById("taskTitle");
    const taskProject = document.getElementById("taskProject");
    const taskDue = document.getElementById("taskDue");
    const taskNotes = document.getElementById("taskNotes");
    const taskColumn = document.getElementById("taskColumn");
    const taskAgent = document.getElementById("taskAgent");
    const taskModel = document.getElementById("taskModel");
    const taskTime = document.getElementById("taskTime");
    const taskCost = document.getElementById("taskCost");
    const saveBtn = document.getElementById("saveBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const cardDetailBackdrop = document.getElementById("cardDetailBackdrop");
    const cardDetailBack = document.getElementById("cardDetailBack");
    const cardDetailProject = document.getElementById("cardDetailProject");
    const cardDetailTitle = document.getElementById("cardDetailTitle");
    const cardDetailMeta = document.getElementById("cardDetailMeta");
    const cardDetailNotes = document.getElementById("cardDetailNotes");
    const cardDetailAttachments = document.getElementById("cardDetailAttachments");
    const cardDetailComments = document.getElementById("cardDetailComments");
    const cardDetailHistoryToggle = document.getElementById("cardDetailHistoryToggle");
    const cardDetailHistory = document.getElementById("cardDetailHistory");
    const cardDetailEditBtn = document.getElementById("cardDetailEditBtn");
    const cardDetailDeleteBtn = document.getElementById("cardDetailDeleteBtn");
    const cardCommentInput = document.getElementById("cardCommentInput");
    const cardCommentSendBtn = document.getElementById("cardCommentSendBtn");

    const costSummaryEl = document.getElementById("costSummary");
    const sparklineChartEl = document.getElementById("sparklineChart");
    const costModelFilterEl = document.getElementById("costModelFilter");
    const costDateRangeEl = document.getElementById("costDateRange");
    const modelBarsEl = document.getElementById("modelBars");
    const projectCardsEl = document.getElementById("projectCards");
    const costTableHeadRow = document.getElementById("costTableHeadRow");
    const costTableBody = document.getElementById("costTableBody");
    const agentsContainer = document.getElementById("agentsContainer");
    const feedTimeline = document.getElementById("feedTimeline");
    const pipelineCompletionEl = document.getElementById("pipelineCompletion");
    const pipelineProgressFillEl = document.getElementById("pipelineProgressFill");
    const pipelineSummaryStatsEl = document.getElementById("pipelineSummaryStats");
    const pipelineActiveEl = document.getElementById("pipelineActive");
    const pipelinePlannedEl = document.getElementById("pipelinePlanned");
    const pipelineDoneEl = document.getElementById("pipelineDone");

    const columns = [
      { key: "done", title: "Done", indicatorClass: "done" },
      { key: "active", title: "Active", indicatorClass: "active" },
      { key: "planned", title: "Planned", indicatorClass: "planned" }
    ];

    let tasks = [];
    let activity = [];
    let appState = demoState();
    let activeTab = "board";
    let activeBoardColumn = "active";
    let doneCollapsed = false;
    let editingId = null;
    let viewingId = null;
    let stateSource = "Demo fallback";
    let stateFingerprint = "";
    let boardFingerprint = "";
    let lastSyncAt = null;
    let githubWriteStatusTimer = null;
    const costFilterState = { model: "all", range: "48h" };

    function nowISO() {
      return new Date().toISOString();
    }

    function safeParse(raw, fallback) {
      if (!raw) return fallback;
      try {
        return JSON.parse(raw);
      } catch {
        return fallback;
      }
    }

    function demoState() {
      const today = new Date();
      const base = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 8, 30, 0);
      const isoAt = (hoursOffset) => new Date(base.getTime() + hoursOffset * 60 * 60 * 1000).toISOString();
      return {
        lastUpdated: isoAt(13),
        agents: {
          watson: { status: "online", model: "claude-opus-4-6", lastActivity: isoAt(13) },
          codex: { status: "idle", model: "gpt-5.3-codex", lastActivity: isoAt(11.5) },
          ollama: { status: "online", models: ["qwen2.5-coder:3b", "llama3.2:3b", "llama3.2:1b"], lastActivity: isoAt(10) }
        },
        costs: {
          summary: { today: 4.86, week: 18.42, month: 54.73, projectedMonth: 171.70, dailyAvg: 5.47 },
          models: [
            { id: "anthropic/claude-opus-4-6", name: "claude-opus-4-6", provider: "anthropic", cost: 1.53, tokensIn: 6942, tokensOut: 2244, calls: 2, avgCost: 0.77, cacheRead: 500, cacheWrite: 2100, cacheHitRate: 0.19 },
            { id: "openai/gpt-5.3-codex", name: "gpt-5.3-codex", provider: "openai", cost: 3.22, tokensIn: 17510, tokensOut: 6430, calls: 2, avgCost: 1.61, cacheRead: 0, cacheWrite: 3300, cacheHitRate: 0 },
            { id: "ollama/qwen2.5-coder:3b", name: "qwen2.5-coder:3b", provider: "ollama", cost: 0.11, tokensIn: 4200, tokensOut: 1900, calls: 1, avgCost: 0.11, cacheRead: 0, cacheWrite: 0, cacheHitRate: 0 }
          ],
          projects: [
            { id: "command-center", name: "Command Center", totalCost: 42.50, taskCount: 8, completedTasks: 6 },
            { id: "coachfinder", name: "CoachFinder", totalCost: 8.20, taskCount: 3, completedTasks: 1 }
          ],
          activity: [
            { hour: isoAt(12), model: "claude-opus-4-6", calls: 1, tokensIn: 930, tokensOut: 400, cost: 0.11 },
            { hour: isoAt(9), model: "gpt-5.3-codex", calls: 1, tokensIn: 3190, tokensOut: 1210, cost: 0.49 },
            { hour: isoAt(7), model: "qwen2.5-coder:3b", calls: 1, tokensIn: 4200, tokensOut: 1900, cost: 0.11 }
          ],
          dailyHistory: [
            { date: "2026-02-04", cost: 3.21, calls: 40 },
            { date: "2026-02-05", cost: 7.88, calls: 95 },
            { date: "2026-02-06", cost: 5.12, calls: 62 },
            { date: "2026-02-07", cost: 2.44, calls: 30 },
            { date: "2026-02-08", cost: 12.67, calls: 155 },
            { date: "2026-02-09", cost: 9.34, calls: 110 },
            { date: "2026-02-10", cost: 4.86, calls: 58 }
          ],
          entries: []
        },
        feed: [
          { ts: isoAt(8.5), agent: "watson", type: "info", text: "Morning sync kicked off", detail: "Checked priorities across Board, Agents, and Costs." },
          { ts: isoAt(9), agent: "codex", type: "success", text: "Command Center v3.0 tabs implemented", detail: "Board, Agents, Costs, and Feed are all wired." },
          { ts: isoAt(10), agent: "watson", type: "warning", text: "state.json unavailable", detail: "Using demo fallback payload until Watson syncs state.json." },
          { ts: isoAt(11), agent: "ollama", type: "message", text: "Local models warmed up", detail: "qwen2.5-coder:3b responded in 1.8s." },
          { ts: isoAt(12.5), agent: "watson", type: "success", text: "Export/import and theme parity validated", detail: "Light and dark mode contrast checks passed." },
          { ts: isoAt(13), agent: "watson", type: "info", text: "Waiting for next command", detail: "Ready for new queue items." }
        ]
      };
    }

    function seedTasks() {
      const createdAt = nowISO();
      return [
        { id: crypto.randomUUID(), title: "Security audit completed", column: "done", priority: "high", project: "Infrastructure", notes: "Final report delivered.", dueDate: "", createdAt, completedAt: createdAt, assignedAgent: "watson", model: null, estimatedTime: "1h", estimatedCost: 1.1 },
        { id: crypto.randomUUID(), title: "Kanban Pro dashboard built", column: "done", priority: "high", project: "Infrastructure", notes: "Initial shell and board completed.", dueDate: "", createdAt, completedAt: createdAt, assignedAgent: "codex", model: "gpt-5.3-codex", estimatedTime: "2h", estimatedCost: 2.3 },
        { id: crypto.randomUUID(), title: "Ollama installed with 3 models", column: "done", priority: "high", project: "Watson", notes: "qwen + llama3.2 variants available.", dueDate: "", createdAt, completedAt: createdAt, assignedAgent: "watson", model: null, estimatedTime: "30m", estimatedCost: 0.4 },
        { id: crypto.randomUUID(), title: "Telegram gateway configured", column: "done", priority: "medium", project: "Watson", notes: "Inbound relay validated.", dueDate: "", createdAt, completedAt: createdAt, assignedAgent: "watson", model: null, estimatedTime: "1h", estimatedCost: 0.3 },
        { id: crypto.randomUUID(), title: "CoachFinder design system v2", column: "done", priority: "high", project: "CoachFinder", notes: "Typography and spacing tokens finalized.", dueDate: "", createdAt, completedAt: createdAt, assignedAgent: "codex", model: "gpt-5.3-codex", estimatedTime: "4h", estimatedCost: 2.1 },
        { id: crypto.randomUUID(), title: "HubSpot integration complete", column: "done", priority: "high", project: "CoachFinder", notes: "Contact sync and lead status mapping done.", dueDate: "", createdAt, completedAt: createdAt, assignedAgent: "codex", model: "gpt-5.3-codex", estimatedTime: "6h", estimatedCost: 1.9 },
        { id: crypto.randomUUID(), title: "Command Center v3.0", column: "active", priority: "high", project: "Infrastructure", notes: "Major expansion with agents/cost/feed.", dueDate: "", createdAt, completedAt: "", assignedAgent: "codex", model: "gpt-5.3-codex", estimatedTime: "3h", estimatedCost: 2.7 },
        { id: crypto.randomUUID(), title: "Twitter/YouTube research workflow", column: "planned", priority: "medium", project: "Lead Intel", notes: "Define automation and source scoring.", dueDate: "", createdAt, completedAt: "", assignedAgent: "watson", model: null, estimatedTime: "2d", estimatedCost: 0.8 },
        { id: crypto.randomUUID(), title: "Fix bird CLI for Twitter access", column: "planned", priority: "low", project: "Lead Intel", notes: "Re-auth and endpoint compatibility fixes.", dueDate: "", createdAt, completedAt: "", assignedAgent: "watson", model: null, estimatedTime: "4h", estimatedCost: 0.6 },
        { id: crypto.randomUUID(), title: "CoachFinder full pipeline integration", column: "planned", priority: "high", project: "CoachFinder", notes: "Wire the complete ingestion-to-HubSpot path.", dueDate: "", createdAt, completedAt: "", assignedAgent: "codex", model: "gpt-5.3-codex", estimatedTime: "1w", estimatedCost: 3.4 },
        { id: crypto.randomUUID(), title: "Dashboard documentation", column: "planned", priority: "low", project: "Infrastructure", notes: "Document setup, data flow, and runbook.", dueDate: "", createdAt, completedAt: "", assignedAgent: "watson", model: null, estimatedTime: "2h", estimatedCost: 0.4 }
      ];
    }

    function normalizeTask(input) {
      if (!input || typeof input !== "object") return null;
      const id = typeof input.id === "string" && input.id.trim() ? input.id : crypto.randomUUID();
      const title = typeof input.title === "string" ? input.title.trim() : "";
      if (!title) return null;
      const validColumns = new Set(columns.map(col => col.key));
      const column = validColumns.has(input.column) ? input.column : "planned";
      const priority = ["high", "medium", "low"].includes(input.priority) ? input.priority : "medium";
      const project = typeof input.project === "string" && input.project.trim() ? input.project.trim() : "Other";
      const notes = typeof input.notes === "string" ? input.notes : "";
      const dueDate = typeof input.dueDate === "string" ? input.dueDate : "";
      const createdAt = typeof input.createdAt === "string" ? input.createdAt : nowISO();
      const completedAt = column === "done"
        ? (typeof input.completedAt === "string" && input.completedAt ? input.completedAt : nowISO())
        : "";
      const assignedAgent = ["watson", "codex", "ollama"].includes(input.assignedAgent) ? input.assignedAgent : null;
      const model = typeof input.model === "string" && input.model.trim() ? input.model.trim() : null;
      const estimatedTime = typeof input.estimatedTime === "string" ? input.estimatedTime.trim() : "";
      const estimatedCost = Number.isFinite(Number(input.estimatedCost)) ? Number(input.estimatedCost) : null;
      const attachments = Array.isArray(input.attachments)
        ? input.attachments
          .map(normalizeAttachment)
          .filter(Boolean)
        : [];
      const comments = Array.isArray(input.comments)
        ? input.comments
          .map(normalizeComment)
          .filter(Boolean)
        : [];
      const history = Array.isArray(input.history)
        ? input.history
          .map(normalizeHistoryEvent)
          .filter(Boolean)
        : [];
      return { id, title, column, priority, project, notes, dueDate, createdAt, completedAt, assignedAgent, model, estimatedTime, estimatedCost, attachments, comments, history };
    }

    function normalizeComment(input) {
      if (!input || typeof input !== "object") return null;
      const text = typeof input.text === "string" ? input.text.trim() : "";
      if (!text) return null;
      const author = typeof input.author === "string" && input.author.trim() ? input.author.trim().toLowerCase() : "paul";
      const authorLabel = typeof input.authorLabel === "string" && input.authorLabel.trim()
        ? input.authorLabel.trim()
        : authorLabelFor(author);
      return {
        id: typeof input.id === "string" && input.id.trim() ? input.id : crypto.randomUUID(),
        author,
        authorLabel,
        text,
        timestamp: typeof input.timestamp === "string" && input.timestamp ? input.timestamp : nowISO()
      };
    }

    function normalizeAttachment(input) {
      if (!input || typeof input !== "object") return null;
      const filename = typeof input.filename === "string" ? input.filename.trim() : "";
      if (!filename) return null;
      return {
        filename,
        addedBy: typeof input.addedBy === "string" && input.addedBy.trim() ? input.addedBy.trim() : "unknown",
        addedAt: typeof input.addedAt === "string" && input.addedAt ? input.addedAt : nowISO()
      };
    }

    function normalizeHistoryEvent(input) {
      if (!input || typeof input !== "object") return null;
      const action = ["created", "moved", "edited"].includes(input.action) ? input.action : "edited";
      return {
        action,
        by: typeof input.by === "string" && input.by.trim() ? input.by.trim() : "unknown",
        at: typeof input.at === "string" && input.at ? input.at : nowISO(),
        from: typeof input.from === "string" ? input.from : undefined,
        to: typeof input.to === "string" ? input.to : undefined,
        field: typeof input.field === "string" ? input.field : undefined
      };
    }

    function normalizeActivity(input) {
      if (!input || typeof input !== "object") return null;
      const message = typeof input.message === "string" ? input.message.trim() : "";
      if (!message) return null;
      return {
        id: typeof input.id === "string" && input.id.trim() ? input.id : crypto.randomUUID(),
        message,
        ts: typeof input.ts === "string" && input.ts ? input.ts : nowISO()
      };
    }

    function normalizeFeedEntry(item) {
      if (!item || typeof item !== "object") return null;
      const text = typeof item.text === "string" ? item.text.trim() : "";
      if (!text) return null;
      return {
        ts: typeof item.ts === "string" && item.ts ? item.ts : nowISO(),
        agent: ["watson", "codex", "ollama"].includes(item.agent) ? item.agent : "watson",
        type: ["info", "success", "warning", "error", "message"].includes(item.type) ? item.type : "info",
        text,
        detail: typeof item.detail === "string" ? item.detail : ""
      };
    }

    function normalizeState(input) {
      const fallback = demoState();
      if (!input || typeof input !== "object") return fallback;

      const valueOr = (v, fallbackValue) => Number.isFinite(Number(v)) ? Number(v) : fallbackValue;

      const costsEntriesRaw = Array.isArray(input.costs?.entries) ? input.costs.entries : fallback.costs.entries;
      const entries = costsEntriesRaw
        .filter(Boolean)
        .map(entry => ({
          date: typeof entry.date === "string" && entry.date ? entry.date : nowISO(),
          agent: ["watson", "codex", "ollama"].includes(entry.agent) ? entry.agent : "watson",
          model: typeof entry.model === "string" && entry.model ? entry.model : "unknown",
          tokensIn: Number.isFinite(Number(entry.tokensIn)) ? Number(entry.tokensIn) : 0,
          tokensOut: Number.isFinite(Number(entry.tokensOut)) ? Number(entry.tokensOut) : 0,
          cost: parseCostValue(entry.cost),
          note: typeof entry.note === "string" ? entry.note : ""
        }));
      const costsActivityRaw = Array.isArray(input.costs?.activity)
        ? input.costs.activity
        : (Array.isArray(fallback.costs.activity) ? fallback.costs.activity : []);
      const activityCostRows = costsActivityRaw
        .filter(Boolean)
        .map(item => ({
          hour: typeof item.hour === "string" && item.hour ? item.hour : nowISO(),
          model: typeof item.model === "string" && item.model ? item.model : "unknown",
          calls: Number.isFinite(Number(item.calls)) ? Number(item.calls) : 0,
          tokensIn: Number.isFinite(Number(item.tokensIn)) ? Number(item.tokensIn) : 0,
          tokensOut: Number.isFinite(Number(item.tokensOut)) ? Number(item.tokensOut) : 0,
          cost: parseCostValue(item.cost)
        }));

      const summary = input.costs?.summary || {
        today: input.costs?.today,
        week: input.costs?.week,
        month: input.costs?.month
      };
      const fallbackSummary = fallback.costs?.summary || {};
      const costsSummary = {
        today: valueOr(summary.today, fallbackSummary.today || 0),
        week: valueOr(summary.week, fallbackSummary.week || 0),
        month: valueOr(summary.month, fallbackSummary.month || 0),
        projectedMonth: valueOr(summary.projectedMonth, 0),
        dailyAvg: valueOr(summary.dailyAvg, 0)
      };

      const modelsRaw = Array.isArray(input.costs?.models)
        ? input.costs.models
        : (Array.isArray(input.costs?.byModel) ? input.costs.byModel : []);
      const fallbackModelsRaw = Array.isArray(fallback.costs?.models)
        ? fallback.costs.models
        : (Array.isArray(fallback.costs?.byModel) ? fallback.costs.byModel : []);
      const costsModelsRaw = modelsRaw.length ? modelsRaw : fallbackModelsRaw;
      const normalizedModels = costsModelsRaw
        .filter(Boolean)
        .map(item => {
          const modelName = typeof item.name === "string" && item.name
            ? item.name
            : (typeof item.model === "string" && item.model ? item.model : "unknown");
          const row = {
            id: typeof item.id === "string" ? item.id : modelName,
            name: modelName,
            provider: typeof item.provider === "string" ? item.provider : "",
            model: modelName,
            cost: parseCostValue(item.cost),
            tokensIn: Number.isFinite(Number(item.tokensIn)) ? Number(item.tokensIn) : 0,
            tokensOut: Number.isFinite(Number(item.tokensOut)) ? Number(item.tokensOut) : 0,
            cacheRead: Number.isFinite(Number(item.cacheRead)) ? Number(item.cacheRead) : 0,
            cacheWrite: Number.isFinite(Number(item.cacheWrite)) ? Number(item.cacheWrite) : 0
          };
          if (Number.isFinite(Number(item.calls))) row.calls = Number(item.calls);
          if (Number.isFinite(Number(item.avgCost))) row.avgCost = Number(item.avgCost);
          if (Number.isFinite(Number(item.cacheHitRate))) row.cacheHitRate = Number(item.cacheHitRate);
          return row;
        });

      const dailyHistory = Array.isArray(input.costs?.dailyHistory)
        ? input.costs.dailyHistory.filter(Boolean).map(d => ({
          date: d.date || "",
          cost: parseCostValue(d.cost),
          calls: Number(d.calls) || 0
        }))
        : [];
      const projects = Array.isArray(input.costs?.projects) ? input.costs.projects : [];

      const agentsIn = input.agents || {};
      const agentBlock = {
        watson: {
          status: ["online", "idle", "offline"].includes(agentsIn.watson?.status) ? agentsIn.watson.status : fallback.agents.watson.status,
          model: typeof agentsIn.watson?.model === "string" ? agentsIn.watson.model : fallback.agents.watson.model,
          lastActivity: typeof agentsIn.watson?.lastActivity === "string" ? agentsIn.watson.lastActivity : fallback.agents.watson.lastActivity
        },
        codex: {
          status: ["online", "idle", "offline"].includes(agentsIn.codex?.status) ? agentsIn.codex.status : fallback.agents.codex.status,
          model: typeof agentsIn.codex?.model === "string" ? agentsIn.codex.model : fallback.agents.codex.model,
          lastActivity: typeof agentsIn.codex?.lastActivity === "string" ? agentsIn.codex.lastActivity : fallback.agents.codex.lastActivity
        },
        ollama: {
          status: ["online", "idle", "offline"].includes(agentsIn.ollama?.status) ? agentsIn.ollama.status : fallback.agents.ollama.status,
          models: Array.isArray(agentsIn.ollama?.models) && agentsIn.ollama.models.length ? agentsIn.ollama.models : fallback.agents.ollama.models,
          lastActivity: typeof agentsIn.ollama?.lastActivity === "string" || agentsIn.ollama?.lastActivity === null
            ? agentsIn.ollama.lastActivity
            : fallback.agents.ollama.lastActivity
        }
      };

      const feed = (Array.isArray(input.feed) ? input.feed : fallback.feed)
        .map(normalizeFeedEntry)
        .filter(Boolean)
        .sort((a, b) => new Date(b.ts) - new Date(a.ts));

      return {
        lastUpdated: typeof input.lastUpdated === "string" ? input.lastUpdated : fallback.lastUpdated,
        agents: agentBlock,
        costs: {
          summary: costsSummary,
          models: normalizedModels,
          projects: projects,
          activity: activityCostRows,
          dailyHistory: dailyHistory,
          entries
        },
        coachfinder: input.coachfinder && typeof input.coachfinder === "object" ? input.coachfinder : null,
        feed
      };
    }

    function loadData() {
      const storedVersion = localStorage.getItem(VERSION_KEY);
      if (storedVersion !== DATA_VERSION) {
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(LOG_KEY);
        localStorage.setItem(VERSION_KEY, DATA_VERSION);
      }

      const stored = localStorage.getItem(STORAGE_KEY);
      const logStored = localStorage.getItem(LOG_KEY);
      const parsedTasks = safeParse(stored, null);
      const parsedActivity = safeParse(logStored, []);
      let shouldReset = false;

      if (Array.isArray(parsedTasks)) {
        tasks = parsedTasks.map(normalizeTask).filter(Boolean);
      } else if (!stored) {
        tasks = seedTasks().map(normalizeTask).filter(Boolean);
      } else {
        tasks = seedTasks().map(normalizeTask).filter(Boolean);
        shouldReset = true;
      }

      activity = Array.isArray(parsedActivity)
        ? parsedActivity.map(normalizeActivity).filter(Boolean).slice(0, 80)
        : [];

      if (shouldReset) {
        activity.unshift({
          id: crypto.randomUUID(),
          message: "Stored data was invalid and has been reset.",
          ts: nowISO()
        });
      }
      boardFingerprint = fingerprintTasks(tasks);
      persist();
    }

    function loadTasksFromStorageOrSeed() {
      const stored = localStorage.getItem(STORAGE_KEY);
      const parsedTasks = safeParse(stored, null);
      if (Array.isArray(parsedTasks)) {
        const normalized = parsedTasks.map(normalizeTask).filter(Boolean);
        if (normalized.length) return normalized;
      }
      return seedTasks().map(normalizeTask).filter(Boolean);
    }

    function persist() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
      localStorage.setItem(LOG_KEY, JSON.stringify(activity));
      localStorage.setItem(VERSION_KEY, DATA_VERSION);
    }

    function logActivity(message) {
      const entry = { id: crypto.randomUUID(), message, ts: nowISO() };
      activity.unshift(entry);
      if (activity.length > 80) activity = activity.slice(0, 80);
      persist();
      renderActivity();
    }

    function formatDate(iso, withTime = false) {
      if (!iso) return "-";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return "-";
      return withTime
        ? d.toLocaleString(undefined, { month: "short", day: "numeric", hour: "2-digit", minute: "2-digit" })
        : d.toLocaleDateString(undefined, { month: "short", day: "numeric" });
    }

    function money(value) {
      return `$${Number(value || 0).toFixed(2)}`;
    }

    function formatTokens(n) {
      const value = Number(n) || 0;
      if (value >= 1000000) return (value / 1000000).toFixed(1) + "M";
      if (value >= 1000) return (value / 1000).toFixed(1) + "K";
      return value.toLocaleString();
    }

    function parseCostValue(value) {
      if (Number.isFinite(Number(value))) return Number(value);
      if (typeof value !== "string") return 0;
      const cleaned = value.replace(/[^0-9.-]/g, "");
      const parsed = Number(cleaned);
      return Number.isFinite(parsed) ? parsed : 0;
    }

    function fingerprintTasks(taskList) {
      return JSON.stringify(taskList || []);
    }

    function fingerprintState(state) {
      return JSON.stringify({
        lastUpdated: state.lastUpdated,
        agents: state.agents,
        costs: {
          summary: state.costs?.summary,
          models: state.costs?.models,
          projects: state.costs?.projects,
          activity: state.costs?.activity,
          dailyHistory: state.costs?.dailyHistory
        },
        coachfinder: state.coachfinder,
        feed: state.feed
      });
    }

    function syncAgeLabel(ts) {
      if (!ts) return "never";
      const elapsed = Math.max(0, Date.now() - ts.getTime());
      const seconds = Math.floor(elapsed / 1000);
      if (seconds < 5) return "just now";
      if (seconds < 60) return `${seconds}s ago`;
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      return `${hours}h ago`;
    }

    function renderSyncIndicator() {
      syncUpdatedEl.textContent = `Last updated: ${syncAgeLabel(lastSyncAt)}`;
    }

    function maskToken(token) {
      const value = String(token || "").trim();
      if (!value) return "";
      if (value.length <= 8) return "•".repeat(value.length);
      return `${value.slice(0, 4)}${"•".repeat(Math.max(4, value.length - 8))}${value.slice(-4)}`;
    }

    function getGithubPat() {
      return (localStorage.getItem(GITHUB_PAT_KEY) || "").trim();
    }

    // Diagnostic: run `await testGithubPat()` in browser console
    async function testGithubPat() {
      const pat = getGithubPat();
      if (!pat) {
        console.error("❌ No PAT set. Go to Settings → GitHub token");
        return { ok: false, error: "PAT not set" };
      }
      console.log("Testing PAT...");
      const endpoint = `https://api.github.com/repos/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}`;
      const res = await fetch(endpoint, {
        headers: {
          Accept: "application/vnd.github+json",
          Authorization: `Bearer ${pat}`,
          "X-GitHub-Api-Version": "2022-11-28"
        }
      });
      if (res.status === 401) {
        console.error("❌ PAT is invalid or expired");
        return { ok: false, error: "Unauthorized", status: 401 };
      }
      if (res.status === 403) {
        console.error("❌ PAT lacks permissions (needs Contents: Read+Write)");
        return { ok: false, error: "Forbidden", status: 403 };
      }
      if (!res.ok) {
        console.error("❌ GitHub API error:", res.status, await res.text());
        return { ok: false, error: "API error", status: res.status };
      }
      const data = await res.json();
      console.log("✅ PAT works! Repo:", data.full_name);
      console.log("   Permissions:", data.permissions);
      return { ok: true, repo: data.full_name, permissions: data.permissions };
    }

    function showGithubWriteStatus(text, tone) {
      if (!githubWriteStatusEl) return;
      if (githubWriteStatusTimer) clearTimeout(githubWriteStatusTimer);
      githubWriteStatusEl.textContent = text;
      githubWriteStatusEl.classList.remove("ok", "warn", "show");
      githubWriteStatusEl.classList.add(tone === "ok" ? "ok" : "warn");
      requestAnimationFrame(() => githubWriteStatusEl.classList.add("show"));
      githubWriteStatusTimer = setTimeout(() => {
        githubWriteStatusEl.classList.remove("show");
      }, 1800);
    }

    function toBase64Utf8(value) {
      const bytes = new TextEncoder().encode(String(value ?? ""));
      let binary = "";
      bytes.forEach(byte => {
        binary += String.fromCharCode(byte);
      });
      return btoa(binary);
    }

    function githubContentPath(path) {
      return String(path || "")
        .split("/")
        .filter(Boolean)
        .map(part => encodeURIComponent(part))
        .join("/");
    }

    async function githubWriteFile(path, content, message) {
      const pat = getGithubPat();
      if (!pat) throw new Error("PAT not set — go to Settings and add your GitHub token");
      if (!pat.startsWith("github_pat_") && !pat.startsWith("ghp_")) {
        throw new Error("PAT format invalid — must start with github_pat_ or ghp_");
      }

      const contentPath = githubContentPath(path);
      if (!contentPath) throw new Error("Invalid file path");

      const endpoint = `https://api.github.com/repos/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/contents/${contentPath}`;
      const headers = {
        Accept: "application/vnd.github+json",
        Authorization: `Bearer ${pat}`,
        "Content-Type": "application/json",
        "X-GitHub-Api-Version": "2022-11-28"
      };

      let sha;
      const getResponse = await fetch(endpoint, { method: "GET", headers });
      if (getResponse.status === 401) {
        const err = await getResponse.json().catch(() => ({}));
        throw new Error(`PAT invalid or expired: ${err.message || "Unauthorized"}`);
      }
      if (getResponse.status === 403) {
        const err = await getResponse.json().catch(() => ({}));
        throw new Error(`PAT lacks permissions: ${err.message || "Forbidden — needs Contents: Read+Write"}`);
      }
      if (getResponse.status !== 404) {
        if (!getResponse.ok) {
          const getError = await getResponse.text();
          throw new Error(`GitHub GET failed (${getResponse.status}): ${getError.slice(0, 200)}`);
        }
        const existing = await getResponse.json();
        sha = existing?.sha;
      }

      const body = {
        message: message || `Update ${path}`,
        content: toBase64Utf8(content)
      };
      if (sha) body.sha = sha;

      const putResponse = await fetch(endpoint, {
        method: "PUT",
        headers,
        body: JSON.stringify(body)
      });
      if (putResponse.status === 401) {
        const err = await putResponse.json().catch(() => ({}));
        throw new Error(`PAT invalid: ${err.message || "Unauthorized"}`);
      }
      if (putResponse.status === 403) {
        const err = await putResponse.json().catch(() => ({}));
        throw new Error(`PAT lacks write access: ${err.message || "Forbidden"}`);
      }
      if (!putResponse.ok) {
        const putError = await putResponse.text();
        throw new Error(`GitHub PUT failed (${putResponse.status}): ${putError.slice(0, 200)}`);
      }

      showGithubWriteStatus("Saved to GitHub", "ok");
      return putResponse.json();
    }

    async function githubWriteBoardJson() {
      const payload = {
        version: "3.0",
        lastModified: nowISO(),
        modifiedBy: "paul",
        tasks
      };
      const content = `${JSON.stringify(payload, null, 2)}\n`;
      const message = `Update board.json (${new Date().toISOString()})`;
      return githubWriteFile("board.json", content, message);
    }

    function queueGithubBoardWrite() {
      githubWriteBoardJson().catch(error => {
        console.error("GitHub board write failed:", error);
        const msg = error?.message || "Unknown error";
        // Show detailed error in UI for 5 seconds, then revert to generic message
        showGithubWriteStatus(`Error: ${msg.slice(0, 60)}`, "warn");
        setTimeout(() => showGithubWriteStatus("Local only (GitHub failed)", "warn"), 5000);
      });
    }

    function formatEstimatedTime(value) {
      const v = typeof value === "string" ? value.trim() : "";
      return v;
    }

    function parseEstimatedMinutes(value) {
      const input = formatEstimatedTime(value).toLowerCase().replace(/\s+/g, "");
      if (!input) return null;
      const match = input.match(/^(\d+(?:\.\d+)?)(m|h|d|w)$/);
      if (!match) return null;
      const amount = Number(match[1]);
      if (!Number.isFinite(amount) || amount < 0) return null;
      const unit = match[2];
      const minutesByUnit = { m: 1, h: 60, d: 60 * 24, w: 60 * 24 * 7 };
      return Math.round(amount * minutesByUnit[unit]);
    }

    function formatMinutesTotal(minutes) {
      if (!Number.isFinite(minutes) || minutes <= 0) return "0";
      let remaining = Math.round(minutes);
      const week = Math.floor(remaining / (60 * 24 * 7));
      remaining -= week * 60 * 24 * 7;
      const day = Math.floor(remaining / (60 * 24));
      remaining -= day * 60 * 24;
      const hour = Math.floor(remaining / 60);
      remaining -= hour * 60;
      const parts = [];
      if (week) parts.push(`${week}w`);
      if (day) parts.push(`${day}d`);
      if (hour) parts.push(`${hour}h`);
      if (remaining) parts.push(`${remaining}m`);
      return parts.join(" ") || "0";
    }

    function columnBorderColor(column) {
      if (column === "done") return "#22c55e";
      if (column === "active") return "#3b82f6";
      return "#f59e0b";
    }

    function agentBadge(agentKey) {
      if (!agentKey || !AGENT_META[agentKey]) return "<span class='agent-badge'>Unassigned</span>";
      const meta = AGENT_META[agentKey];
      return `<span class='agent-badge'><span class='agent-dot ${meta.dotClass}'></span>${meta.name}</span>`;
    }

    function agentNameBadge(agentKey, className = "agent-name") {
      const meta = AGENT_META[agentKey];
      if (!meta) return `<span class="${className}">Unknown</span>`;
      return `<span class="${className}"><span class="agent-dot ${meta.dotClass}"></span>${meta.name}</span>`;
    }

    function authorLabelFor(author) {
      if (author === "watson") return "Watson";
      if (author === "codex") return "Codex";
      return "Paul";
    }

    function relativeTime(iso) {
      if (!iso) return "just now";
      const ts = new Date(iso).getTime();
      if (!Number.isFinite(ts)) return "just now";
      const diff = Date.now() - ts;
      const minute = 60 * 1000;
      const hour = 60 * minute;
      const day = 24 * hour;
      if (diff < minute) return "just now";
      if (diff < hour) return `${Math.max(1, Math.floor(diff / minute))}m ago`;
      if (diff < day) return `${Math.floor(diff / hour)}h ago`;
      if (diff < day * 7) return `${Math.floor(diff / day)}d ago`;
      return formatDate(iso, true);
    }

    function historyText(event) {
      if (event.action === "created") return "Created";
      if (event.action === "moved") return `Moved ${event.from || "unknown"} → ${event.to || "unknown"}`;
      if (event.action === "edited") return `Edited ${event.field || "task"}`;
      return "Updated";
    }

    function isMobile() {
      return window.matchMedia("(max-width: 719px)").matches;
    }

    function renderBoard() {
      const counts = {
        done: tasks.filter(t => t.column === "done").length,
        active: tasks.filter(t => t.column === "active").length,
        planned: tasks.filter(t => t.column === "planned").length
      };

      const total = tasks.length;
      const completion = total ? Math.round((counts.done / total) * 100) : 0;
      const remainingMinutes = tasks
        .filter(t => t.column === "active" || t.column === "planned")
        .reduce((sum, t) => sum + (parseEstimatedMinutes(t.estimatedTime) || 0), 0);
      totalCountEl.textContent = total;
      completionPctEl.textContent = `${completion}%`;
      doneCountEl.textContent = counts.done;
      activeCountEl.textContent = counts.active;
      plannedCountEl.textContent = counts.planned;
      remainingEstimateEl.textContent = formatMinutesTotal(remainingMinutes);
      progressBarEl.style.width = `${completion}%`;

      columnsEl.innerHTML = "";

      columns.forEach(col => {
        const colTasks = tasks.filter(t => t.column === col.key);
        const columnEl = document.createElement("section");
        columnEl.className = "column";

        const shell = document.createElement("div");
        shell.className = "column-shell";

        const header = document.createElement("div");
        header.className = "column-header";
        header.innerHTML = `<div class='column-title'><span class='status-indicator ${col.indicatorClass}'></span>${col.title}</div><span class='badge'>${colTasks.length}</span>`;

        if (col.key === "done" && isMobile() && doneCollapsed) {
          const collapsed = document.createElement("div");
          collapsed.className = "done-collapsed";
          collapsed.innerHTML = `<span>Done collapsed</span><span class='badge'>${colTasks.length}</span>`;
          collapsed.addEventListener("click", () => {
            doneCollapsed = false;
            renderBoard();
          });
          shell.appendChild(header);
          shell.appendChild(collapsed);
        } else {
          header.addEventListener("click", () => {
            if (col.key === "done" && isMobile()) {
              doneCollapsed = !doneCollapsed;
              renderBoard();
            }
          });

          shell.appendChild(header);

          colTasks.forEach((task, idx) => {
            const card = document.createElement("div");
            card.className = "card";
            card.tabIndex = 0;
            card.setAttribute("role", "button");
            card.setAttribute("aria-label", `Open task details for ${task.title}`);
            card.style.borderLeftColor = columnBorderColor(task.column);
            card.style.animationDelay = `${Math.min(idx * 40, 160)}ms`;

            const due = task.dueDate ? `Due ${formatDate(task.dueDate)}` : "";
            const titleEl = document.createElement("h4");
            titleEl.textContent = task.title;

            const metaEl = document.createElement("div");
            metaEl.className = "meta";

            const projectEl = document.createElement("span");
            projectEl.className = "pill";
            projectEl.textContent = task.project;

            const priorityEl = document.createElement("span");
            priorityEl.className = `pill priority-${task.priority}`;
            priorityEl.textContent = task.priority;

            metaEl.appendChild(projectEl);
            metaEl.appendChild(priorityEl);

            if (due) {
              const dueEl = document.createElement("span");
              dueEl.className = "pill";
              dueEl.textContent = due;
              metaEl.appendChild(dueEl);
            }

            if (task.model) {
              const modelEl = document.createElement("span");
              modelEl.className = "pill card-detail-only";
              modelEl.textContent = task.model;
              metaEl.appendChild(modelEl);
            }

            const estimate = formatEstimatedTime(task.estimatedTime);
            if (estimate) {
              const timeEl = document.createElement("span");
              timeEl.className = "pill chip card-detail-only";
              timeEl.textContent = `Time ${estimate}`;
              metaEl.appendChild(timeEl);
            }

            if (task.estimatedCost !== null) {
              const costEl = document.createElement("span");
              costEl.className = "pill card-detail-only";
              costEl.textContent = `est ${money(task.estimatedCost)}`;
              metaEl.appendChild(costEl);
            }

            const agentWrap = document.createElement("div");
            agentWrap.className = "meta";
            agentWrap.innerHTML = agentBadge(task.assignedAgent);

            card.appendChild(titleEl);
            card.appendChild(agentWrap);
            card.appendChild(metaEl);

            card.addEventListener("click", () => openCardDetail(task.id));
            card.addEventListener("keydown", e => {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                openCardDetail(task.id);
              }
            });

            shell.appendChild(card);
          });
        }

        const addBtn = document.createElement("button");
        addBtn.className = "add-btn";
        addBtn.innerHTML = "+ Add Card";
        addBtn.addEventListener("click", () => openModal(null, col.key));
        shell.appendChild(addBtn);

        columnEl.appendChild(shell);
        columnsEl.appendChild(columnEl);
      });

      if (isMobile()) {
        const index = columns.findIndex(c => c.key === activeBoardColumn);
        columnsEl.style.transform = `translateX(-${index * 100}%)`;
      } else {
        columnsEl.style.transform = "none";
      }

      document.querySelectorAll(".board-subtab").forEach(tab => {
        tab.classList.toggle("active", tab.dataset.column === activeBoardColumn);
      });
    }

    function renderAgents() {
      const agents = appState.agents || {};
      const ordered = ["watson", "codex", "ollama"];
      agentsContainer.innerHTML = "";

      ordered.forEach(key => {
        const meta = AGENT_META[key];
        const state = agents[key] || {};
        const status = ["online", "idle", "offline"].includes(state.status) ? state.status : "offline";
        const assigned = tasks.filter(task => task.assignedAgent === key);
        const activeCount = assigned.filter(task => task.column === "active").length;
        const totalEstimatedMinutes = assigned
          .reduce((sum, task) => sum + (parseEstimatedMinutes(task.estimatedTime) || 0), 0);
        const model = key === "ollama"
          ? (Array.isArray(state.models) && state.models.length ? state.models.join(", ") : meta.defaultModel)
          : (state.model || meta.defaultModel);

        const card = document.createElement("article");
        card.className = `agent-card ${status === "online" ? "online" : ""}`;
        card.innerHTML = `
          <div class="agent-head">
            <div><strong>${agentNameBadge(key)}</strong><div style="font-size:12px; color:var(--text-secondary); margin-top:2px;">${meta.role}</div></div>
            <div class="status"><span class="status-dot ${status}"></span>${status}</div>
          </div>
          <div class="agent-kv">
            <div>Model: <strong>${model}</strong></div>
            <div>Active tasks: <strong>${activeCount}</strong></div>
            <div>Assigned total: <strong>${assigned.length}</strong></div>
            <div>Estimated time: <strong>${formatMinutesTotal(totalEstimatedMinutes)}</strong></div>
            <div>Last activity: <strong>${state.lastActivity ? formatDate(state.lastActivity, true) : "No recent activity"}</strong></div>
          </div>
          <div class="task-list" id="agent-task-${key}"></div>
        `;

        const list = card.querySelector(`#agent-task-${key}`);
        if (!assigned.length) {
          const empty = document.createElement("div");
          empty.className = "task-line";
          empty.textContent = "No assigned tasks";
          list.appendChild(empty);
        } else {
          assigned.slice(0, 8).forEach(task => {
            const line = document.createElement("div");
            line.className = "task-line";
            line.textContent = `${task.title} (${task.column})`;
            list.appendChild(line);
          });
        }

        agentsContainer.appendChild(card);
      });
    }

    function renderCosts() {
      const costs = appState.costs || {
        summary: { today: 0, week: 0, month: 0, projectedMonth: 0, dailyAvg: 0 },
        models: [],
        projects: [],
        activity: [],
        dailyHistory: [],
        entries: []
      };
      const entries = Array.isArray(costs.entries) ? costs.entries : [];
      const activityRows = Array.isArray(costs.activity) ? costs.activity : [];
      const summary = costs.summary || {
        today: Number(costs.today) || 0,
        week: Number(costs.week) || 0,
        month: Number(costs.month) || 0,
        projectedMonth: 0,
        dailyAvg: 0
      };
      const costsModels = Array.isArray(costs.models)
        ? costs.models
        : (Array.isArray(costs.byModel) ? costs.byModel : []);
      const projects = Array.isArray(costs.projects) ? costs.projects : [];
      const history = Array.isArray(costs.dailyHistory) ? costs.dailyHistory : [];
      const displayCost = (value) => money(value);
      const modelLabel = (row) => {
        if (!row || typeof row !== "object") return "unknown";
        if (typeof row.name === "string" && row.name) return row.name;
        if (typeof row.model === "string" && row.model) return row.model;
        if (typeof row.id === "string" && row.id) {
          const chunks = row.id.split("/");
          return chunks[chunks.length - 1] || row.id;
        }
        return "unknown";
      };
      const shortModelName = (model) => {
        if (typeof model !== "string" || !model) return "unknown";
        const chunks = model.split("/");
        return chunks[chunks.length - 1] || model;
      };
      const formatActivityTime = (iso) => {
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return "-";
        const now = new Date();
        const isToday = d.getFullYear() === now.getFullYear()
          && d.getMonth() === now.getMonth()
          && d.getDate() === now.getDate();
        const timePart = d.toLocaleString(undefined, { hour: "numeric" }).toLowerCase().replace(/\s+/g, "");
        if (isToday) return `Today ${timePart}`;
        const datePart = d.toLocaleDateString(undefined, { month: "short", day: "numeric" });
        return `${datePart}, ${timePart}`;
      };
      const fallbackByModel = () => {
        const modelMap = new Map();
        entries.forEach((entry) => {
          const key = entry.model || "unknown";
          const current = modelMap.get(key) || { id: key, name: shortModelName(key), model: key, cost: 0, tokensIn: 0, tokensOut: 0 };
          current.cost += parseCostValue(entry.cost);
          current.tokensIn += Number(entry.tokensIn) || 0;
          current.tokensOut += Number(entry.tokensOut) || 0;
          modelMap.set(key, current);
        });
        return Array.from(modelMap.values());
      };
      const byModelRowsRaw = costsModels.length ? costsModels : fallbackByModel();

      const budget = JSON.parse(localStorage.getItem("costBudget") || "null");
      const budgetClass = (value, limit) => {
        if (!Number.isFinite(Number(limit)) || Number(limit) <= 0) return "";
        if (Number(value) > Number(limit)) return "cost-danger";
        if (Number(value) > Number(limit) * Number(budget?.alertAt || 0.8)) return "cost-warn";
        return "";
      };
      const dailyAvg = Number(summary.dailyAvg) || 0;
      const summaryCards = [
        { label: "Today", value: displayCost(summary.today || 0), className: budgetClass(summary.today || 0, budget?.daily) },
        { label: "This Week", value: displayCost(summary.week || 0), className: "" },
        { label: "This Month", value: displayCost(summary.month || 0), className: budgetClass(summary.month || 0, budget?.monthly), subvalue: `Avg ${displayCost(dailyAvg)}/day` },
        { label: "Projected Month", value: displayCost(summary.projectedMonth || 0), className: "" }
      ];
      costSummaryEl.innerHTML = summaryCards.map(item => {
        const cardClass = item.className ? `cost-card ${item.className}` : "cost-card";
        return `<article class="${cardClass}"><div class="label">${item.label}</div><div class="value">${item.value}</div>${item.subvalue ? `<div class="subvalue">${item.subvalue}</div>` : ""}</article>`;
      }).join("");

      if (sparklineChartEl) {
        if (!history.length) {
          sparklineChartEl.innerHTML = "<div class='model-bar-row'>No daily data yet.</div>";
        } else {
          // Filter history by date range
          const rangeMs = costFilterState.range === "7d"
            ? 7 * 86400000
            : (costFilterState.range === "30d" ? 30 * 86400000 : 2 * 86400000); // 48h = 2 days
          const cutoff = Date.now() - rangeMs;
          const filteredHistory = history.filter(d => {
            const ts = new Date(d.date + "T00:00:00").getTime();
            return Number.isFinite(ts) && ts >= cutoff;
          });

          if (!filteredHistory.length) {
            sparklineChartEl.innerHTML = "<div class='model-bar-row'>No data for selected range.</div>";
          } else {
            const maxCost = Math.max(...filteredHistory.map(d => d.cost), 1);
            sparklineChartEl.innerHTML = filteredHistory.map(d => {
              const pct = Math.max(4, Math.round((d.cost / maxCost) * 100));
              const dayLabel = new Date(d.date + "T12:00:00").toLocaleDateString(undefined, { weekday: "short" });
              return `<div class="spark-bar-wrap" title="${d.date}: ${money(d.cost)} (${d.calls} calls)">
        <div class="spark-bar" style="height:${pct}%"></div>
        <div class="spark-label">${dayLabel}</div>
      </div>`;
            }).join("");
          }
        }
      }

      if (costModelFilterEl) {
        const modelNames = Array.from(new Set(byModelRowsRaw.map(row => shortModelName(modelLabel(row))).filter(Boolean)));
        costModelFilterEl.innerHTML = `<option value="all">All Models</option>${modelNames.map(model => `<option value="${model}">${model}</option>`).join("")}`;
        if (!modelNames.includes(costFilterState.model)) {
          costFilterState.model = "all";
        }
        costModelFilterEl.value = costFilterState.model;
        if (!costModelFilterEl.dataset.bound) {
          costModelFilterEl.addEventListener("change", () => {
            costFilterState.model = costModelFilterEl.value || "all";
            renderCosts();
          });
          costModelFilterEl.dataset.bound = "true";
        }
      }

      if (costDateRangeEl) {
        costDateRangeEl.querySelectorAll(".seg-btn").forEach((button) => {
          button.classList.toggle("active", button.dataset.range === costFilterState.range);
        });
        if (!costDateRangeEl.dataset.bound) {
          costDateRangeEl.addEventListener("click", (event) => {
            const btn = event.target.closest(".seg-btn");
            if (!btn || !btn.dataset.range) return;
            costFilterState.range = btn.dataset.range;
            renderCosts();
          });
          costDateRangeEl.dataset.bound = "true";
        }
      }

      const sortedModels = byModelRowsRaw
        .slice()
        .sort((a, b) => parseCostValue(b.cost) - parseCostValue(a.cost));
      const max = sortedModels.length ? Math.max(...sortedModels.map(item => parseCostValue(item.cost)), 0) : 0;

      modelBarsEl.innerHTML = "";
      if (!sortedModels.length) {
        modelBarsEl.innerHTML = "<div class='model-bar-row'>No cost data yet.</div>";
      } else {
        const selectedModel = costFilterState.model;
        sortedModels.forEach((rowData) => {
          const model = shortModelName(modelLabel(rowData));
          const cost = parseCostValue(rowData.cost);
          const pct = max > 0 ? Math.max(8, Math.round((cost / max) * 100)) : 8;
          const isDimmed = selectedModel !== "all" && model !== selectedModel;
          const meta = [];
          if (Number.isFinite(Number(rowData.calls))) {
            meta.push(`<span class="model-meta-pill">${Number(rowData.calls).toLocaleString()} calls</span>`);
          }
          if (Number.isFinite(Number(rowData.avgCost))) {
            meta.push(`<span class="model-meta-pill">Avg ${money(rowData.avgCost)}</span>`);
          }
          meta.push(`<span class="model-meta-pill">${formatTokens(rowData.tokensIn)} in · ${formatTokens(rowData.tokensOut)} out</span>`);
          const cacheRead = Number(rowData.cacheRead) || 0;
          const cacheWrite = Number(rowData.cacheWrite) || 0;
          const cacheTotal = cacheRead + cacheWrite;
          if (cacheTotal > 0) {
            const cacheLabel = cacheRead > 0
              ? `Cache: ${Math.round((cacheRead / cacheTotal) * 100)}% hit`
              : "Cache: warming";
            meta.push(`<span class="model-meta-pill cache">${cacheLabel}</span>`);
          }
          const row = document.createElement("div");
          row.className = "model-bar-row";
          if (isDimmed) {
            row.style.opacity = "0.3";
          }
          row.innerHTML = `
            <div class="model-bar-main"><strong>${model}</strong><span>${displayCost(cost)}</span></div>
            <div class="model-bar-meta">${meta.join("")}</div>
            <div class='bar-track'><div class='bar-fill' style='--bar-width:${pct}%'></div></div>
          `;
          modelBarsEl.appendChild(row);
        });
      }

      if (projectCardsEl) {
        if (!projects.length) {
          projectCardsEl.innerHTML = "<div class='model-bar-row'>No project data yet.</div>";
        } else {
          const maxProjectCost = Math.max(...projects.map(p => p.totalCost || 0), 1);
          projectCardsEl.innerHTML = projects.map(p => {
            const pct = Math.max(8, Math.round(((p.totalCost || 0) / maxProjectCost) * 100));
            const taskInfo = `${p.completedTasks || 0}/${p.taskCount || 0} tasks`;
            return `<div class="model-bar-row">
        <div class="model-bar-main"><strong>${p.name}</strong><span>${money(p.totalCost || 0)}</span></div>
        <div class="model-bar-meta"><span class="model-meta-pill">${taskInfo}</span></div>
        <div class="bar-track"><div class="bar-fill" style="--bar-width:${pct}%"></div></div>
      </div>`;
          }).join("");
        }
      }

      costTableBody.innerHTML = "";

      // Calculate filter parameters for both activity and entries
      const rangeMs = costFilterState.range === "7d"
        ? 7 * 86400000
        : (costFilterState.range === "30d" ? 30 * 86400000 : 48 * 3600000);
      const cutoff = Date.now() - rangeMs;
      const selectedModel = costFilterState.model;

      if (activityRows.length) {
        if (costTableHeadRow) {
          costTableHeadRow.innerHTML = `
            <th>Time</th>
            <th>Model</th>
            <th>Calls</th>
            <th>Tokens In</th>
            <th>Tokens Out</th>
            <th>Cost</th>
          `;
        }
        const filteredRows = activityRows
          .filter((entry) => {
            const ts = new Date(entry.hour).getTime();
            if (Number.isFinite(ts) && ts < cutoff) return false;
            if (selectedModel !== "all") {
              const model = shortModelName(entry.model);
              return model === selectedModel;
            }
            return true;
          })
          .slice()
          .sort((a, b) => new Date(b.hour) - new Date(a.hour));

        if (!filteredRows.length) {
          const tr = document.createElement("tr");
          tr.innerHTML = "<td colspan='6'>No activity for selected filters.</td>";
          costTableBody.appendChild(tr);
        } else {
          filteredRows.forEach((entry) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${formatActivityTime(entry.hour)}</td>
              <td>${shortModelName(entry.model)}</td>
              <td>${(Number(entry.calls) || 0).toLocaleString()}</td>
              <td>${formatTokens(entry.tokensIn)}</td>
              <td>${formatTokens(entry.tokensOut)}</td>
              <td>${money(entry.cost)}</td>
            `;
            costTableBody.appendChild(tr);
          });
        }
      } else if (!entries.length) {
        if (costTableHeadRow) {
          costTableHeadRow.innerHTML = `
            <th>Time</th>
            <th>Model</th>
            <th>Calls</th>
            <th>Tokens In</th>
            <th>Tokens Out</th>
            <th>Cost</th>
          `;
        }
        const tr = document.createElement("tr");
        tr.innerHTML = "<td colspan='6'>No activity yet.</td>";
        costTableBody.appendChild(tr);
      } else {
        // Apply filters to entries as well
        if (costTableHeadRow) {
          costTableHeadRow.innerHTML = `
            <th>Date</th>
            <th>Agent</th>
            <th>Model</th>
            <th>Tokens In</th>
            <th>Tokens Out</th>
            <th>Cost</th>
            <th data-col="note">Note</th>
          `;
        }
        const filteredEntries = entries
          .filter((entry) => {
            const ts = new Date(entry.date).getTime();
            if (Number.isFinite(ts) && ts < cutoff) return false;
            if (selectedModel !== "all") {
              const model = shortModelName(entry.model);
              return model === selectedModel;
            }
            return true;
          })
          .slice()
          .sort((a, b) => new Date(b.date) - new Date(a.date));

        if (!filteredEntries.length) {
          const tr = document.createElement("tr");
          tr.innerHTML = "<td colspan='7'>No entries for selected filters.</td>";
          costTableBody.appendChild(tr);
        } else {
          filteredEntries.forEach(entry => {
            const tr = document.createElement("tr");
            const agent = AGENT_META[entry.agent] ? agentNameBadge(entry.agent) : entry.agent;
            tr.innerHTML = `
              <td>${formatDate(entry.date, true)}</td>
              <td>${agent}</td>
              <td>${shortModelName(entry.model)}</td>
              <td>${formatTokens(entry.tokensIn)}</td>
              <td>${formatTokens(entry.tokensOut)}</td>
              <td>${money(entry.cost)}</td>
              <td data-col="note">${entry.note || "-"}</td>
            `;
            costTableBody.appendChild(tr);
          });
        }
      }
    }

    function renderPipeline() {
      const active = tasks.filter(t => t.column === "active");
      const planned = tasks.filter(t => t.column === "planned");
      const done = tasks.filter(t => t.column === "done");
      const total = tasks.length;
      const pct = total ? Math.round((done.length / total) * 100) : 0;

      pipelineCompletionEl.textContent = `${pct}%`;
      pipelineProgressFillEl.style.setProperty("--bar-width", `${pct}%`);

      pipelineSummaryStatsEl.innerHTML = `
        <span class="pill">${active.length} active</span>
        <span class="pill">${planned.length} planned</span>
        <span class="pill">${done.length} done</span>
        <span class="pill">${total} total</span>
      `;

      function renderProjectCard(task) {
        const card = document.createElement("article");
        card.className = "pipeline-project-card" + (task.column === "done" ? " done" : "");
        card.setAttribute("role", "button");
        card.setAttribute("tabindex", "0");
        card.setAttribute("aria-label", "Open task details for " + task.title);

        const agent = task.assignedAgent ? agentNameBadge(task.assignedAgent) : "Unassigned";
        const commentCount = (task.comments || []).length;
        const latestComment = commentCount ? (task.comments || []).slice().sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0] : null;
        const notesPreview = task.notes ? task.notes.substring(0, 120) + (task.notes.length > 120 ? "..." : "") : "";

        let footerHtml = "";
        if (commentCount) {
          footerHtml += `<span>${commentCount} comment${commentCount !== 1 ? "s" : ""}</span>`;
        }
        if (latestComment) {
          footerHtml += `<span>Last: ${relativeTime(latestComment.timestamp)}</span>`;
        }
        if (task.estimatedTime) {
          footerHtml += `<span>Est: ${task.estimatedTime}</span>`;
        }

        card.innerHTML = `
          <div class="project-title">${task.title}</div>
          <div class="project-meta">
            <span class="pill">${agent}</span>
            <span class="pill priority-${task.priority}">${task.priority}</span>
            <span class="pill">${task.project || "Other"}</span>
          </div>
          ${notesPreview ? `<div class="project-notes">${notesPreview}</div>` : ""}
          ${footerHtml ? `<div class="project-footer">${footerHtml}</div>` : ""}
        `;

        card.addEventListener("click", () => openCardDetail(task.id));
        card.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") { e.preventDefault(); openCardDetail(task.id); }
        });

        return card;
      }

      pipelineActiveEl.innerHTML = "";
      if (!active.length) {
        pipelineActiveEl.innerHTML = '<p class="empty-state-text">No active projects right now.</p>';
      } else {
        active.forEach(t => pipelineActiveEl.appendChild(renderProjectCard(t)));
      }

      pipelinePlannedEl.innerHTML = "";
      if (!planned.length) {
        pipelinePlannedEl.innerHTML = '<p class="empty-state-text">No planned projects.</p>';
      } else {
        planned.forEach(t => pipelinePlannedEl.appendChild(renderProjectCard(t)));
      }

      pipelineDoneEl.innerHTML = "";
      const recentDone = done.slice().sort((a, b) => new Date(b.completedAt || b.createdAt) - new Date(a.completedAt || a.createdAt)).slice(0, 5);
      if (!recentDone.length) {
        pipelineDoneEl.innerHTML = '<p class="empty-state-text">No completed projects yet.</p>';
      } else {
        recentDone.forEach(t => pipelineDoneEl.appendChild(renderProjectCard(t)));
      }
    }

    function renderFeed() {
      const feed = Array.isArray(appState.feed) ? appState.feed : [];
      feedTimeline.innerHTML = "";

      if (!feed.length) {
        const empty = document.createElement("div");
        empty.className = "timeline-item feed-info";
        empty.innerHTML = "<p class='timeline-text empty-state-text'>Feed entries will appear here as work progresses.</p>";
        feedTimeline.appendChild(empty);
        return;
      }

      feed.forEach(entry => {
        const agent = AGENT_META[entry.agent] ? agentNameBadge(entry.agent) : agentNameBadge("watson");
        const item = document.createElement("article");
        item.className = `timeline-item feed-${entry.type}`;
        item.innerHTML = `
          <div class="timeline-head">
            <span>${agent}</span>
            <span>${formatDate(entry.ts, true)}</span>
          </div>
          <p class="timeline-text">${entry.text}</p>
          ${entry.detail ? `<p class='timeline-detail'>${entry.detail}</p>` : ""}
        `;
        feedTimeline.appendChild(item);
      });
    }

    function renderActivity() {
      activityList.innerHTML = "";
      if (!activity.length) {
        const empty = document.createElement("div");
        empty.className = "activity-item empty-state-text";
        empty.textContent = "Activity will appear here as tasks are created, moved, and completed.";
        activityList.appendChild(empty);
        return;
      }

      activity.forEach(entry => {
        const item = document.createElement("div");
        item.className = "activity-item";
        const when = new Date(entry.ts).toLocaleString();
        const strong = document.createElement("strong");
        strong.textContent = entry.message;
        const time = document.createElement("span");
        time.textContent = when;
        item.appendChild(strong);
        item.appendChild(time);
        activityList.appendChild(item);
      });
    }

    function renderTabState() {
      document.querySelectorAll(".tab-btn, .tab-mobile").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === activeTab);
      });
      document.querySelectorAll(".panel").forEach(panel => {
        panel.classList.remove("fade-in");
        if (panel.id === `panel-${activeTab}`) {
          panel.classList.add("active");
          requestAnimationFrame(() => panel.classList.add("fade-in"));
        } else {
          panel.classList.remove("active");
        }
      });
      if (activeTab === "board") renderBoard();
      if (activeTab === "agents") renderAgents();
      if (activeTab === "costs") renderCosts();
      if (activeTab === "pipeline") renderPipeline();
      if (activeTab === "feed") renderFeed();
    }

    function openCardDetail(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      viewingId = id;
      renderCardDetail(task);
      cardDetailBackdrop.classList.add("open");
      requestAnimationFrame(() => cardDetailBack.focus());
    }

    function closeCardDetail() {
      cardDetailBackdrop.classList.remove("open");
      viewingId = null;
      cardCommentInput.value = "";
    }

    function renderCardDetail(task) {
      cardDetailProject.textContent = task.project || "Other";
      cardDetailTitle.textContent = task.title;

      cardDetailMeta.innerHTML = "";
      const assigned = task.assignedAgent && AGENT_META[task.assignedAgent]
        ? AGENT_META[task.assignedAgent].name
        : "Unassigned";
      const metaValues = [
        { text: assigned, className: "pill" },
        { text: task.priority, className: `pill priority-${task.priority}` },
        ...(task.estimatedTime ? [{ text: `Time: ${task.estimatedTime}`, className: "pill" }] : []),
        ...(task.estimatedCost !== null ? [{ text: `Est ${money(task.estimatedCost)}`, className: "pill" }] : []),
        { text: `Status: ${task.column}`, className: "pill" }
      ];
      metaValues.forEach(item => {
        const chip = document.createElement("span");
        chip.className = item.className;
        chip.textContent = item.text;
        cardDetailMeta.appendChild(chip);
      });

      if (task.notes?.trim()) {
        cardDetailNotes.textContent = task.notes;
        cardDetailNotes.classList.remove("empty-state-text");
      } else {
        cardDetailNotes.textContent = "No notes yet. Add context, decisions, or links.";
        cardDetailNotes.classList.add("empty-state-text");
      }

      cardDetailAttachments.innerHTML = "";
      if (!task.attachments.length) {
        const empty = document.createElement("li");
        empty.className = "empty-state-text";
        empty.textContent = "No attachments yet.";
        cardDetailAttachments.appendChild(empty);
      } else {
        task.attachments.forEach(attachment => {
          const li = document.createElement("li");
          const link = document.createElement("a");
          link.href = `cards/${task.id}/${encodeURIComponent(attachment.filename)}`;
          link.textContent = `Attachment: ${attachment.filename}`;
          link.target = "_blank";
          link.rel = "noopener noreferrer";
          li.appendChild(link);
          cardDetailAttachments.appendChild(li);
        });
      }

      cardDetailComments.innerHTML = "";
      const sortedComments = task.comments.slice().sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      if (!sortedComments.length) {
        const empty = document.createElement("div");
        empty.className = "comment-bubble";
        empty.textContent = "No comments yet.";
        cardDetailComments.appendChild(empty);
      } else {
        sortedComments.forEach(comment => {
          const bubble = document.createElement("article");
          bubble.className = "comment-bubble";

          const head = document.createElement("div");
          head.className = "comment-head";
          const author = document.createElement("span");
          const cleanedLabel = (comment.authorLabel || authorLabelFor(comment.author)).replace(/^(?:[\u{1F300}-\u{1FAFF}\u2600-\u27BF]\s*)+/u, "");
          author.innerHTML = AGENT_META[comment.author]
            ? agentNameBadge(comment.author)
            : cleanedLabel || authorLabelFor(comment.author);
          const time = document.createElement("span");
          time.textContent = relativeTime(comment.timestamp);
          head.appendChild(author);
          head.appendChild(time);

          const text = document.createElement("p");
          text.className = "comment-text";
          text.textContent = comment.text;

          bubble.appendChild(head);
          bubble.appendChild(text);
          cardDetailComments.appendChild(bubble);
        });
      }

      cardDetailHistory.innerHTML = "";
      const sortedHistory = task.history.slice().sort((a, b) => new Date(b.at) - new Date(a.at));
      if (!sortedHistory.length) {
        const empty = document.createElement("div");
        empty.className = "history-item";
        empty.textContent = "No history yet.";
        cardDetailHistory.appendChild(empty);
      } else {
        sortedHistory.forEach(event => {
          const item = document.createElement("article");
          item.className = "history-item";
          const title = document.createElement("strong");
          title.textContent = historyText(event);
          const meta = document.createElement("span");
          meta.textContent = `${event.by || "unknown"} • ${formatDate(event.at, true)}`;
          item.appendChild(title);
          item.appendChild(meta);
          cardDetailHistory.appendChild(item);
        });
      }
      cardDetailHistoryToggle.open = Boolean(sortedHistory.length);
    }

    function appendTaskHistory(task, event) {
      if (!task) return;
      if (!Array.isArray(task.history)) task.history = [];
      const normalized = normalizeHistoryEvent(event);
      if (normalized) task.history.push(normalized);
    }

    function deleteTaskById(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return false;
      tasks = tasks.filter(t => t.id !== taskId);
      logActivity(`Deleted: ${task.title}`);
      persist();
      renderBoard();
      if (activeTab === "agents") renderAgents();
      if (viewingId === taskId) closeCardDetail();
      queueGithubBoardWrite();
      return true;
    }

    function openModal(id, presetColumn) {
      editingId = id;
      if (id) {
        const task = tasks.find(t => t.id === id);
        if (!task) return;
        modalTitle.textContent = "Edit Task";
        taskTitle.value = task.title;
        const projectValue = task.project || "Other";
        taskProject.value = Array.from(taskProject.options).some(option => option.value === projectValue)
          ? projectValue
          : "Other";
        taskDue.value = task.dueDate || "";
        taskNotes.value = task.notes || "";
        taskColumn.value = task.column;
        taskAgent.value = task.assignedAgent || "";
        taskModel.value = task.model || "";
        taskTime.value = task.estimatedTime || "";
        taskCost.value = task.estimatedCost === null ? "" : String(task.estimatedCost);
        document.querySelectorAll("input[name='priority']").forEach(r => {
          r.checked = r.value === task.priority;
        });
        deleteBtn.style.display = "inline-flex";
      } else {
        modalTitle.textContent = "Add Task";
        taskTitle.value = "";
        taskProject.value = "Infrastructure";
        taskDue.value = "";
        taskNotes.value = "";
        taskColumn.value = presetColumn || activeBoardColumn;
        taskAgent.value = "";
        taskModel.value = "";
        taskTime.value = "";
        taskCost.value = "";
        document.querySelectorAll("input[name='priority']").forEach(r => {
          r.checked = r.value === "medium";
        });
        deleteBtn.style.display = "none";
      }

      modalBackdrop.classList.add("open");
      if (isMobile()) modal.classList.add("fullscreen");
      else modal.classList.remove("fullscreen");
      requestAnimationFrame(() => taskTitle.focus());
    }

    function closeModal() {
      modalBackdrop.classList.remove("open");
      editingId = null;
    }

    function saveTask() {
      const title = taskTitle.value.trim();
      if (!title) {
        taskTitle.focus();
        return;
      }

      const priority = document.querySelector("input[name='priority']:checked")?.value || "medium";
      const project = taskProject.value;
      const dueDate = taskDue.value;
      const notes = taskNotes.value;
      const column = columns.some(c => c.key === taskColumn.value) ? taskColumn.value : activeBoardColumn;
      const assignedAgent = ["watson", "codex", "ollama"].includes(taskAgent.value) ? taskAgent.value : null;
      const model = taskModel.value.trim() || null;
      const estimatedTime = taskTime.value.trim();
      const estimatedCostRaw = taskCost.value.trim();
      const estimatedCost = estimatedCostRaw === "" ? null : Number(estimatedCostRaw);

      if (estimatedCostRaw !== "" && (!Number.isFinite(estimatedCost) || estimatedCost < 0)) {
        taskCost.focus();
        return;
      }

      if (editingId) {
        const task = tasks.find(t => t.id === editingId);
        if (!task) return;
        const prevColumn = task.column;
        const previousValues = {
          title: task.title,
          priority: task.priority,
          project: task.project,
          notes: task.notes,
          dueDate: task.dueDate,
          assignedAgent: task.assignedAgent,
          model: task.model,
          estimatedTime: task.estimatedTime,
          estimatedCost: task.estimatedCost
        };
        task.title = title;
        task.priority = priority;
        task.project = project;
        task.notes = notes;
        task.dueDate = dueDate;
        task.column = column;
        task.assignedAgent = assignedAgent;
        task.model = model;
        task.estimatedTime = estimatedTime;
        task.estimatedCost = estimatedCost;
        if (column === "done" && !task.completedAt) task.completedAt = nowISO();
        if (column !== "done") task.completedAt = "";
        if (prevColumn !== column) {
          appendTaskHistory(task, { action: "moved", from: prevColumn, to: column, by: "paul", at: nowISO() });
        }
        Object.entries(previousValues).forEach(([field, from]) => {
          const to = task[field];
          if (from === to) return;
          appendTaskHistory(task, { action: "edited", field, from: String(from ?? ""), to: String(to ?? ""), by: "paul", at: nowISO() });
        });
        logActivity(`Edited: ${task.title}`);
        if (prevColumn !== column) logActivity(`Moved: ${task.title} → ${column}`);
      } else {
        const newTask = {
          id: crypto.randomUUID(),
          title,
          column,
          priority,
          project,
          notes,
          dueDate,
          createdAt: nowISO(),
          completedAt: column === "done" ? nowISO() : "",
          assignedAgent,
          model,
          estimatedTime,
          estimatedCost,
          attachments: [],
          comments: [],
          history: [{ action: "created", by: "paul", at: nowISO() }]
        };
        tasks.unshift(newTask);
        logActivity(`Added: ${newTask.title}`);
      }

      persist();
      renderBoard();
      if (activeTab === "agents") renderAgents();
      closeModal();
      queueGithubBoardWrite();
    }

    function deleteTask() {
      if (!editingId) return;
      deleteTaskById(editingId);
      closeModal();
    }

    function addCommentToViewingTask() {
      if (!viewingId) return;
      const text = cardCommentInput.value.trim();
      if (!text) {
        cardCommentInput.focus();
        return;
      }
      const task = tasks.find(t => t.id === viewingId);
      if (!task) return;
      if (!Array.isArray(task.comments)) task.comments = [];
      const comment = normalizeComment({
        id: crypto.randomUUID(),
        author: "paul",
        authorLabel: "Paul",
        text,
        timestamp: nowISO()
      });
      task.comments.push(comment);
      appendTaskHistory(task, { action: "edited", field: "comments", by: "paul", at: nowISO() });
      logActivity(`Commented: ${task.title}`);
      persist();
      cardCommentInput.value = "";
      renderCardDetail(task);
      queueGithubBoardWrite();
    }

    function renderGithubSettings() {
      const pat = getGithubPat();
      githubPatPreview.textContent = pat ? `Saved token: ${maskToken(pat)}` : "No token saved";
      githubPatClearBtn.disabled = !pat;
      githubPatInput.value = "";
      githubPatInput.placeholder = pat ? "Enter new token to replace" : "github_pat_...";
    }

    function openSettings() {
      renderGithubSettings();
      const budget = JSON.parse(localStorage.getItem("costBudget") || "null");
      if (budget) {
        budgetDailyInput.value = budget.daily || "";
        budgetMonthlyInput.value = budget.monthly || "";
      } else {
        budgetDailyInput.value = "";
        budgetMonthlyInput.value = "";
      }
      settingsBackdrop.classList.add("open");
      requestAnimationFrame(() => githubPatInput.focus());
    }

    function closeSettings() {
      settingsBackdrop.classList.remove("open");
      githubPatInput.value = "";
      budgetDailyInput.value = "";
      budgetMonthlyInput.value = "";
    }

    function saveGithubSettings() {
      const nextPat = githubPatInput.value.trim();
      if (nextPat) localStorage.setItem(GITHUB_PAT_KEY, nextPat);
      const daily = parseFloat(budgetDailyInput.value) || null;
      const monthly = parseFloat(budgetMonthlyInput.value) || null;
      if (daily || monthly) {
        localStorage.setItem("costBudget", JSON.stringify({ daily, monthly, alertAt: 0.8 }));
      } else {
        localStorage.removeItem("costBudget");
      }
      renderGithubSettings();
      closeSettings();
      showGithubWriteStatus(nextPat ? "GitHub token saved" : "Settings saved", "ok");
      if (activeTab === "costs") renderCosts();
    }

    function clearGithubSettings() {
      localStorage.removeItem(GITHUB_PAT_KEY);
      renderGithubSettings();
      showGithubWriteStatus("Local only", "warn");
    }

    function initSettings() {
      settingsBtn.addEventListener("click", () => {
        menuPanel.classList.remove("open");
        openSettings();
      });
      settingsClose.addEventListener("click", closeSettings);
      settingsCancelBtn.addEventListener("click", closeSettings);
      settingsSaveBtn.addEventListener("click", saveGithubSettings);
      githubPatClearBtn.addEventListener("click", clearGithubSettings);
      settingsBackdrop.addEventListener("click", e => {
        if (e.target === settingsBackdrop) closeSettings();
      });
    }

    function initTabs() {
      document.querySelectorAll(".tab-btn, .tab-mobile").forEach(btn => {
        btn.addEventListener("click", () => {
          activeTab = btn.dataset.tab;
          renderTabState();
        });
      });
    }

    function initBoardSubtabs() {
      document.querySelectorAll(".board-subtab").forEach(btn => {
        btn.addEventListener("click", () => {
          activeBoardColumn = btn.dataset.column;
          renderBoard();
        });
      });
    }

    function initSwipe() {
      let startX = 0;
      let endX = 0;
      let dragging = false;

      columnsEl.addEventListener("touchstart", e => {
        if (!isMobile() || activeTab !== "board") return;
        startX = e.touches[0].clientX;
        endX = startX;
        dragging = true;
      }, { passive: true });

      columnsEl.addEventListener("touchmove", e => {
        if (!dragging || !isMobile() || activeTab !== "board") return;
        endX = e.touches[0].clientX;
      }, { passive: true });

      columnsEl.addEventListener("touchend", () => {
        if (!dragging || !isMobile() || activeTab !== "board") return;
        const diff = endX - startX;
        if (Math.abs(diff) > 50) {
          const index = columns.findIndex(c => c.key === activeBoardColumn);
          const nextIndex = diff < 0 ? index + 1 : index - 1;
          if (columns[nextIndex]) {
            activeBoardColumn = columns[nextIndex].key;
            renderBoard();
          }
        }
        dragging = false;
      });

      columnsEl.addEventListener("touchcancel", () => { dragging = false; });
    }

    function initTheme() {
      const stored = localStorage.getItem(THEME_KEY);
      const theme = stored === "light" || stored === "dark" ? stored : "dark";
      document.documentElement.dataset.theme = theme;
      document.body.dataset.theme = theme;

      document.getElementById("themeToggle").addEventListener("click", () => {
        const next = document.documentElement.dataset.theme === "dark" ? "light" : "dark";
        document.documentElement.dataset.theme = next;
        document.body.dataset.theme = next;
        localStorage.setItem(THEME_KEY, next);
      });
    }

    function initMenu() {
      document.getElementById("menuToggle").addEventListener("click", () => {
        menuPanel.classList.toggle("open");
      });

      document.addEventListener("click", e => {
        if (!e.target.closest(".menu")) menuPanel.classList.remove("open");
      });

      document.getElementById("exportBtn").addEventListener("click", () => {
        const payload = { tasks, activity };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "command-center-v3.0.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        logActivity("Exported JSON snapshot");
        menuPanel.classList.remove("open");
      });

      document.getElementById("importBtn").addEventListener("click", () => {
        importFile.value = "";
        importFile.click();
        menuPanel.classList.remove("open");
      });

      importFile.addEventListener("change", e => {
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();

        reader.onload = () => {
          try {
            const parsed = JSON.parse(reader.result);
            if (!parsed.tasks || !Array.isArray(parsed.tasks)) throw new Error("Invalid");
            const confirmReplace = confirm("Import will replace current data. Continue?");
            if (!confirmReplace) return;

            tasks = parsed.tasks.map(normalizeTask).filter(Boolean);
            if (!tasks.length) throw new Error("Invalid");

            activity = Array.isArray(parsed.activity)
              ? parsed.activity.map(normalizeActivity).filter(Boolean).slice(0, 80)
              : [];

            logActivity(`Imported ${tasks.length} task${tasks.length === 1 ? "" : "s"}`);
            persist();
            renderBoard();
            renderActivity();
            if (activeTab === "agents") renderAgents();
          } catch {
            alert("Invalid JSON file.");
          }
        };

        reader.readAsText(file);
      });
    }

    function initModal() {
      document.getElementById("modalClose").addEventListener("click", closeModal);
      modalBackdrop.addEventListener("click", e => {
        if (e.target === modalBackdrop) closeModal();
      });
      cancelBtn.addEventListener("click", closeModal);
      saveBtn.addEventListener("click", saveTask);
      deleteBtn.addEventListener("click", deleteTask);

      document.addEventListener("keydown", e => {
        if (e.key === "Escape") {
          if (cardDetailBackdrop.classList.contains("open")) closeCardDetail();
          if (modalBackdrop.classList.contains("open")) closeModal();
          if (settingsBackdrop.classList.contains("open")) closeSettings();
          if (activityPanel.classList.contains("open")) activityPanel.classList.remove("open");
          if (activityPanel.classList.contains("mobile-open")) activityPanel.classList.remove("mobile-open");
          menuPanel.classList.remove("open");
        }
      });
    }

    function initCardDetail() {
      cardDetailBack.addEventListener("click", closeCardDetail);
      cardDetailBackdrop.addEventListener("click", e => {
        if (e.target === cardDetailBackdrop) closeCardDetail();
      });
      cardDetailEditBtn.addEventListener("click", () => {
        if (!viewingId) return;
        const id = viewingId;
        closeCardDetail();
        openModal(id);
      });
      cardDetailDeleteBtn.addEventListener("click", () => {
        if (!viewingId) return;
        const task = tasks.find(t => t.id === viewingId);
        if (!task) return;
        const confirmed = confirm(`Delete "${task.title}"?`);
        if (!confirmed) return;
        deleteTaskById(viewingId);
      });
      cardCommentSendBtn.addEventListener("click", addCommentToViewingTask);
      cardCommentInput.addEventListener("keydown", e => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          addCommentToViewingTask();
        }
      });
    }

    function initActivityPanel() {
      const activityToggle = document.getElementById("activityToggle");
      if (activityToggle) {
        activityToggle.addEventListener("click", () => {
          if (isMobile()) {
            activityPanel.classList.toggle("mobile-open");
            return;
          }
          activityPanel.classList.add("open");
        });
      }
      document.getElementById("activityClose").addEventListener("click", () => {
        activityPanel.classList.remove("open");
        activityPanel.classList.remove("mobile-open");
      });
    }

    async function fetchState() {
      let ok = true;
      try {
        const response = await fetch("./state.json", { cache: "no-store" });
        if (!response.ok) throw new Error("unavailable");
        const payload = await response.json();
        appState = normalizeState(payload);
        stateSource = "Live";
      } catch {
        appState = normalizeState(demoState());
        stateSource = "Demo fallback";
        ok = false;
      }

      stateSourceEl.textContent = stateSource;
      lastUpdatedEl.textContent = formatDate(appState.lastUpdated, true);
      const nextFingerprint = fingerprintState(appState);
      const changed = nextFingerprint !== stateFingerprint;
      stateFingerprint = nextFingerprint;
      lastSyncAt = new Date();
      renderSyncIndicator();
      return { ok, changed };
    }

    async function fetchBoard() {
      let ok = true;
      try {
        const response = await fetch("./board.json", { cache: "no-store" });
        if (!response.ok) throw new Error("unavailable");
        const payload = await response.json();
        if (!payload || !Array.isArray(payload.tasks)) throw new Error("invalid");
        const nextTasks = payload.tasks.map(normalizeTask).filter(Boolean);
        if (!nextTasks.length) throw new Error("invalid");
        const nextFingerprint = fingerprintTasks(nextTasks);
        const changed = nextFingerprint !== boardFingerprint;
        tasks = nextTasks;
        boardFingerprint = nextFingerprint;
        persist();
        if (viewingId && !tasks.some(t => t.id === viewingId)) closeCardDetail();
        return { ok, changed };
      } catch {
        ok = false;
        const fallbackTasks = loadTasksFromStorageOrSeed();
        const nextFingerprint = fingerprintTasks(fallbackTasks);
        const changed = nextFingerprint !== boardFingerprint;
        tasks = fallbackTasks;
        boardFingerprint = nextFingerprint;
        persist();
        if (viewingId && !tasks.some(t => t.id === viewingId)) closeCardDetail();
        return { ok, changed };
      }
    }

    async function refreshState(showLog = true, forceRender = false) {
      const [{ ok: stateOk, changed: stateChanged }, { ok: boardOk, changed: boardChanged }] = await Promise.all([
        fetchState(),
        fetchBoard()
      ]);
      if (showLog) {
        const stateText = stateOk ? "state.json refreshed" : "state.json unavailable, using demo data";
        const boardText = boardOk ? "board.json refreshed" : "board.json unavailable, using local cache";
        logActivity(`${stateText}; ${boardText}`);
      }
      const changed = stateChanged || boardChanged;
      if (!forceRender && !changed) return;
      renderBoard();
      if (activeTab === "agents") renderAgents();
      if (activeTab === "costs") renderCosts();
      if (activeTab === "pipeline") renderPipeline();
      if (activeTab === "feed") renderFeed();
      if (viewingId) {
        const task = tasks.find(t => t.id === viewingId);
        if (task) renderCardDetail(task);
      }
    }

    function initRefreshControls() {
      document.getElementById("refreshBtn").addEventListener("click", () => refreshState(true, true));
      document.getElementById("feedRefreshBtn").addEventListener("click", () => refreshState(true, true));

      let startY = 0;
      let pulled = false;
      feedTimeline.addEventListener("touchstart", e => {
        if (feedTimeline.scrollTop > 0 || activeTab !== "feed") return;
        startY = e.touches[0].clientY;
        pulled = true;
      }, { passive: true });

      feedTimeline.addEventListener("touchmove", e => {
        if (!pulled || activeTab !== "feed") return;
        const delta = e.touches[0].clientY - startY;
        if (delta > 72) {
          pulled = false;
          refreshState(true, true);
        }
      }, { passive: true });

      feedTimeline.addEventListener("touchend", () => {
        pulled = false;
      });

      setInterval(() => {
        refreshState(false, false);
      }, 60000);

      setInterval(() => {
        renderSyncIndicator();
      }, 30000);
    }

    function initResize() {
      window.addEventListener("resize", () => {
        if (!isMobile()) activityPanel.classList.remove("mobile-open");
        renderBoard();
      });
    }

    function initServiceWorker() {
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("sw.js").catch(err => {
          console.error("Service worker registration failed", err);
        });
      }
    }

    async function init() {
      loadData();
      initTheme();
      initTabs();
      initBoardSubtabs();
      initSwipe();
      initMenu();
      initSettings();
      initModal();
      initCardDetail();
      initActivityPanel();
      initRefreshControls();
      initResize();
      renderSyncIndicator();
      renderBoard();
      renderActivity();
      await refreshState(false, true);
      renderTabState();
      initServiceWorker();

      // Future Firebase Realtime integration placeholder:
      // const db = getDatabase(firebaseApp);
      // onValue(ref(db, "command-center/feed"), snapshot => {
      //   appState.feed = normalizeIncomingFeed(snapshot.val());
      //   if (activeTab === "feed") renderFeed();
      // });
    }

    init();
  </script>
</body>
</html>
